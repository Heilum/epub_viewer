# EPUB 标注系统使用指南

这个示例应用实现了一个完整的 EPUB 标注系统，支持高亮、笔记等功能。

## 功能特性

### 1. 高亮功能
- **添加高亮**：选中文本后，在上下文菜单中选择"高亮"
- **取消高亮**：如果文本已经高亮，菜单会显示"取消高亮"选项
- 高亮使用黄色背景显示

### 2. 笔记功能
- **添加笔记**：选中任意文本，点击"做笔记"，输入笔记内容
- **多个笔记**：同一段文字可以添加多个笔记
- **视觉标识**：有笔记的文字会显示红色虚线下划线
- **查看笔记**：点击带有红色虚线的文字，会弹出该位置的所有笔记列表
- **删除笔记**：在笔记列表中，每条笔记右侧有删除按钮

### 3. 持久化存储
- 所有标注都会自动保存到本地
- 重新打开应用时，所有标注会自动恢复
- 使用 SharedPreferences 进行数据持久化

### 4. 数据管理
- 点击顶部工具栏的"清除所有标注"按钮，可以删除所有标注

## 技术实现

### 核心类

#### 1. AppAnnotation
定义了标注的数据模型：
- `id`: 唯一标识符
- `cfi`: EPUB CFI 位置信息
- `type`: 标注类型（高亮/笔记）
  - `highlight`: 黄色背景高亮（颜色在视图层定义）
  - `note`: 笔记（视觉上显示为红色虚线下划线，颜色在视图层定义）
- `myNote`: 用户笔记内容（仅 note 类型使用）
- `createdAt`: 创建时间

#### 2. AnnotationManager
管理所有标注的生命周期：
- 加载和保存标注
- 添加、删除、查询标注
- 按 CFI 查找标注
- 检查特定位置是否有高亮或笔记

#### 3. AnnotationSerializer
处理标注的序列化和反序列化，用于持久化存储

### 上下文菜单逻辑

选择文本时，菜单项会动态生成：
- 如果已经高亮 → 显示"取消高亮"
- 如果未高亮 → 显示"高亮"
- 始终显示"做笔记"选项

### 点击交互

点击标注时的行为：
1. 系统检测到标注点击事件
2. 通过 CFI 查找该位置的所有笔记
3. 如果有笔记，弹出列表对话框
4. 用户可以查看和删除笔记

## 使用流程

### 添加高亮
1. 长按选中文字
2. 在弹出菜单中点击"高亮"
3. 文字会立即显示黄色高亮

### 添加笔记
1. 长按选中文字
2. 在弹出菜单中点击"做笔记"
3. 在对话框中输入笔记内容
4. 点击"保存"
5. 文字会显示红色虚线下划线

### 查看笔记
1. 点击带有红色虚线的文字
2. 弹出笔记列表对话框
3. 可以看到该位置的所有笔记及创建时间

### 删除笔记
1. 在笔记列表中点击删除按钮
2. 如果是最后一条笔记，红色下划线会自动消失
3. 如果还有其他笔记，下划线保留

## 扩展建议

可以进一步扩展的功能：
1. 支持编辑已有笔记
2. 支持笔记导出（Markdown, JSON 等）
3. 支持笔记分类和标签
4. 支持笔记搜索
5. 支持云端同步
6. 支持不同颜色的高亮
7. 支持分享标注和笔记
8. 支持笔记排序（按时间、位置等）

## 注意事项

1. **CFI 一致性**：确保相同的文本选区使用相同的 CFI
2. **性能优化**：大量标注时考虑分页加载
3. **数据备份**：重要笔记建议定期导出备份
4. **隐私安全**：敏感内容建议加密存储

