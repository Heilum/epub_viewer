{
    "sourceFile": "lib/src/epub_controller.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1762657251054,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1762657251054,
            "name": "Commit-0",
            "content": "import 'dart:async';\n\nimport 'package:flutter/material.dart';\nimport 'package:flutter_epub_viewer/src/epub_metadata.dart';\nimport 'package:flutter_epub_viewer/src/models/epub_display_settings.dart';\nimport 'package:flutter_epub_viewer/src/models/epub_location.dart';\nimport 'package:flutter_epub_viewer/src/models/epub_search_result.dart';\nimport 'package:flutter_epub_viewer/src/models/epub_text_extract_res.dart';\nimport 'package:flutter_epub_viewer/src/utils.dart';\nimport 'package:flutter_inappwebview/flutter_inappwebview.dart';\n\nimport 'models/epub_chapter.dart';\nimport 'models/epub_theme.dart';\n\nclass EpubController {\n  InAppWebViewController? webViewController;\n\n  ///List of chapters from epub\n  List<EpubChapter> _chapters = [];\n\n  setWebViewController(InAppWebViewController controller) {\n    webViewController = controller;\n  }\n\n  ///Move epub view to specific area using Cfi string or chapter href\n  display({\n    ///Cfi String of the desired location, also accepts chapter href\n    required String cfi,\n  }) {\n    checkEpubLoaded();\n    webViewController?.evaluateJavascript(source: 'toCfi(\"$cfi\")');\n  }\n\n  ///Moves to next page in epub view\n  next() {\n    checkEpubLoaded();\n    webViewController?.evaluateJavascript(source: 'next()');\n  }\n\n  ///Moves to previous page in epub view\n  prev() {\n    checkEpubLoaded();\n    webViewController?.evaluateJavascript(source: 'previous()');\n  }\n\n  ///Returns current location of epub viewer\n  Future<EpubLocation> getCurrentLocation() async {\n    checkEpubLoaded();\n    final result = await webViewController?.evaluateJavascript(\n      source: 'getCurrentLocation()',\n    );\n\n    if (result == null) {\n      throw Exception(\"Epub locations not loaded\");\n    }\n\n    return EpubLocation.fromJson(result);\n  }\n\n  ///Returns list of [EpubChapter] from epub,\n  /// should be called after onChaptersLoaded callback, otherwise returns empty list\n  List<EpubChapter> getChapters() {\n    checkEpubLoaded();\n    return _chapters;\n  }\n\n  Future<List<EpubChapter>> parseChapters() async {\n    if (_chapters.isNotEmpty) return _chapters;\n\n    checkEpubLoaded();\n\n    final result = await webViewController!.evaluateJavascript(\n      source: 'getChapters()',\n    );\n\n    _chapters = parseChapterList(result);\n    return _chapters;\n  }\n\n  Future<EpubMetadata> getMetadata() async {\n    checkEpubLoaded();\n    final result = await webViewController!.evaluateJavascript(\n      source: 'getBookInfo()',\n    );\n    return EpubMetadata.fromJson(result);\n  }\n\n  Completer searchResultCompleter = Completer<List<EpubSearchResult>>();\n\n  ///Search in epub using query string\n  ///Returns a list of [EpubSearchResult]\n  Future<List<EpubSearchResult>> search({\n    ///Search query string\n    required String query,\n    // bool optimized = false,\n  }) async {\n    searchResultCompleter = Completer<List<EpubSearchResult>>();\n    if (query.isEmpty) return [];\n    checkEpubLoaded();\n    await webViewController?.evaluateJavascript(\n      source: 'searchInBook(\"$query\")',\n    );\n    return await searchResultCompleter.future;\n  }\n\n  ///Adds a highlight to epub viewer\n  addHighlight({\n    ///Cfi string of the desired location\n    required String cfi,\n\n    ///Color of the highlight\n    Color color = Colors.yellow,\n\n    ///Opacity of the highlight\n    double opacity = 0.3,\n  }) {\n    var colorHex = color.toHex();\n    var opacityString = opacity.toString();\n    checkEpubLoaded();\n    webViewController?.evaluateJavascript(\n      source: 'addHighlight(\"$cfi\", \"$colorHex\", \"$opacityString\")',\n    );\n  }\n\n  ///Adds a underline annotation\n  addUnderline({\n    ///Cfi string of the desired location\n    required String cfi,\n\n    ///Color of the underline\n    Color color = Colors.black,\n\n    ///Whether to use dashed line style\n    bool isDashed = false,\n  }) {\n    checkEpubLoaded();\n    var colorHex = color.toHex();\n    webViewController?.evaluateJavascript(\n      source: 'addUnderLine(\"$cfi\", \"$colorHex\", $isDashed)',\n    );\n  }\n\n  ///Adds a mark annotation\n  // addMark({required String cfi}) {\n  //   checkEpubLoaded();\n  //   webViewController?.evaluateJavascript(source: 'addMark(\"$cfi\")');\n  // }\n\n  ///Removes a highlight from epub viewer\n  removeHighlight({required String cfi}) {\n    checkEpubLoaded();\n    webViewController?.evaluateJavascript(source: 'removeHighlight(\"$cfi\")');\n  }\n\n  ///Removes a underline from epub viewer\n  removeUnderline({required String cfi}) {\n    checkEpubLoaded();\n    webViewController?.evaluateJavascript(source: 'removeUnderLine(\"$cfi\")');\n  }\n\n  ///Removes a mark from epub viewer\n  // removeMark({required String cfi}) {\n  //   checkEpubLoaded();\n  //   webViewController?.evaluateJavascript(source: 'removeMark(\"$cfi\")');\n  // }\n\n  ///Set [EpubSpread] value\n  setSpread({required EpubSpread spread}) async {\n    await webViewController?.evaluateJavascript(source: 'setSpread(\"$spread\")');\n  }\n\n  ///Set [EpubFlow] value\n  setFlow({required EpubFlow flow}) async {\n    await webViewController?.evaluateJavascript(source: 'setFlow(\"$flow\")');\n  }\n\n  ///Set [EpubManager] value\n  setManager({required EpubManager manager}) async {\n    await webViewController?.evaluateJavascript(\n      source: 'setManager(\"$manager\")',\n    );\n  }\n\n  ///Adjust font size in epub viewer\n  setFontSize({required double fontSize}) async {\n    await webViewController?.evaluateJavascript(\n      source: 'setFontSize(\"$fontSize\")',\n    );\n  }\n\n  updateTheme({required EpubTheme theme}) async {\n    String? foregroundColor = theme.foregroundColor?.toHex();\n    await webViewController?.evaluateJavascript(\n      source: 'updateTheme(\"\",\"$foregroundColor\")',\n    );\n  }\n\n  Completer<EpubTextExtractRes> pageTextCompleter =\n      Completer<EpubTextExtractRes>();\n\n  ///Extract text from a given cfi range,\n  Future<EpubTextExtractRes> extractText({\n    ///start cfi\n    required startCfi,\n\n    ///end cfi\n    required endCfi,\n  }) async {\n    checkEpubLoaded();\n    pageTextCompleter = Completer<EpubTextExtractRes>();\n    await webViewController?.evaluateJavascript(\n      source: 'getTextFromCfi(\"$startCfi\",\"$endCfi\")',\n    );\n    return pageTextCompleter.future;\n  }\n\n  ///Extracts text content from current page\n  Future<EpubTextExtractRes> extractCurrentPageText() async {\n    checkEpubLoaded();\n    pageTextCompleter = Completer<EpubTextExtractRes>();\n    await webViewController?.evaluateJavascript(source: 'getCurrentPageText()');\n    return pageTextCompleter.future;\n  }\n\n  ///Given a percentage moves to the corresponding page\n  ///Progress percentage should be between 0.0 and 1.0\n  toProgressPercentage(double progressPercent) {\n    assert(\n      progressPercent >= 0.0 && progressPercent <= 1.0,\n      'Progress percentage must be between 0.0 and 1.0',\n    );\n    checkEpubLoaded();\n    webViewController?.evaluateJavascript(\n      source: 'toProgress($progressPercent)',\n    );\n  }\n\n  ///Moves to the first page of the epub\n  moveToFistPage() {\n    toProgressPercentage(0.0);\n  }\n\n  ///Moves to the last page of the epub\n  moveToLastPage() {\n    toProgressPercentage(1.0);\n  }\n\n  checkEpubLoaded() {\n    if (webViewController == null) {\n      throw Exception(\n        \"Epub viewer is not loaded, wait for onEpubLoaded callback\",\n      );\n    }\n  }\n}\n\nclass LocalServerController {\n  final InAppLocalhostServer _localhostServer = InAppLocalhostServer(\n    documentRoot: 'packages/flutter_epub_viewer/lib/assets/webpage',\n  );\n\n  Future<void> initServer() async {\n    if (_localhostServer.isRunning()) return;\n    await _localhostServer.start();\n  }\n\n  Future<void> disposeServer() async {\n    if (!_localhostServer.isRunning()) return;\n    await _localhostServer.close();\n  }\n}\n"
        }
    ]
}