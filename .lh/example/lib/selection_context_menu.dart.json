{
    "sourceFile": "example/lib/selection_context_menu.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 11,
            "patches": [
                {
                    "date": 1762672478354,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1762672627268,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,52 +67,62 @@\n   final VoidCallback onCopy;\n   final VoidCallback onDismiss;\n \n   const SelectionContextMenuWidget({\n-    Key? key,\n+    super.key,\n     required this.selectionRect,\n     required this.hasHighlight,\n     required this.onHighlight,\n     required this.onRemoveHighlight,\n     required this.onAddNote,\n     required this.onCopy,\n     required this.onDismiss,\n-  }) : super(key: key);\n+  });\n \n   @override\n   Widget build(BuildContext context) {\n-    return Stack(\n-      children: [\n-        // Invisible barrier to detect taps outside the menu\n-        Positioned.fill(\n-          child: GestureDetector(\n-            onTap: onDismiss,\n-            behavior: HitTestBehavior.translucent,\n+    debugPrint('SelectionContextMenuWidget building...');\n+    return Material(\n+      type: MaterialType.transparency,\n+      child: Stack(\n+        fit: StackFit.expand,\n+        children: [\n+          // Invisible barrier to detect taps outside the menu\n+          GestureDetector(\n+            onTap: () {\n+              debugPrint('Barrier tapped, dismissing menu');\n+              onDismiss();\n+            },\n+            behavior: HitTestBehavior.opaque,\n             child: Container(\n-              color: Colors.transparent,\n+              color: Colors.black.withOpacity(0.01), // Very subtle overlay\n             ),\n           ),\n-        ),\n-        // The actual menu\n-        _buildMenu(context),\n-      ],\n+          // The actual menu\n+          _buildMenu(context),\n+        ],\n+      ),\n     );\n   }\n \n   Widget _buildMenu(BuildContext context) {\n     final screenSize = MediaQuery.of(context).size;\n-    \n+\n     // Calculate menu position (below the selection)\n     double menuTop = selectionRect.bottom + 8;\n     double menuLeft = selectionRect.left;\n-    \n+\n+    debugPrint('Menu position - top: $menuTop, left: $menuLeft');\n+    debugPrint('Selection rect: $selectionRect');\n+    debugPrint('Screen size: $screenSize');\n+\n     // Ensure menu stays within screen bounds\n     const menuHeight = 200.0; // Approximate height\n     if (menuTop + menuHeight > screenSize.height) {\n       // Show above selection if not enough space below\n       menuTop = selectionRect.top - menuHeight - 8;\n     }\n-    \n+\n     // Ensure horizontal position is within bounds\n     const menuWidth = 200.0; // Approximate width\n     if (menuLeft + menuWidth > screenSize.width) {\n       menuLeft = screenSize.width - menuWidth - 16;\n@@ -124,11 +134,17 @@\n     return Positioned(\n       top: menuTop,\n       left: menuLeft,\n       child: Material(\n+        color: Colors.white,\n         elevation: 8,\n         borderRadius: BorderRadius.circular(8),\n         child: Container(\n+          decoration: BoxDecoration(\n+            color: Colors.white,\n+            borderRadius: BorderRadius.circular(8),\n+            border: Border.all(color: Colors.grey.shade300),\n+          ),\n           constraints: BoxConstraints(\n             minWidth: 120,\n             maxWidth: screenSize.width * 0.6,\n           ),\n@@ -143,17 +159,19 @@\n                   label: '复制',\n                   onTap: onCopy,\n                 ),\n                 const Divider(height: 1),\n-                \n+\n                 // Highlight/Remove Highlight button\n                 _MenuItemButton(\n-                  icon: hasHighlight ? Icons.format_underlined : Icons.format_underlined,\n+                  icon: hasHighlight\n+                      ? Icons.format_underlined\n+                      : Icons.format_underlined,\n                   label: hasHighlight ? '删除划线' : '划线',\n                   onTap: hasHighlight ? onRemoveHighlight : onHighlight,\n                 ),\n                 const Divider(height: 1),\n-                \n+\n                 // Note button\n                 _MenuItemButton(\n                   icon: Icons.edit_note,\n                   label: '笔记',\n@@ -174,13 +192,13 @@\n   final String label;\n   final VoidCallback onTap;\n \n   const _MenuItemButton({\n-    Key? key,\n+    super.key,\n     required this.icon,\n     required this.label,\n     required this.onTap,\n-  }) : super(key: key);\n+  });\n \n   @override\n   Widget build(BuildContext context) {\n     return InkWell(\n@@ -203,5 +221,4 @@\n       ),\n     );\n   }\n }\n-\n"
                },
                {
                    "date": 1762672798560,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -105,33 +105,59 @@\n   }\n \n   Widget _buildMenu(BuildContext context) {\n     final screenSize = MediaQuery.of(context).size;\n+    final padding = MediaQuery.of(context).padding;\n+    \n+    // Account for system UI (status bar, navigation bar, etc.)\n+    final safeTop = padding.top;\n+    final safeBottom = screenSize.height - padding.bottom;\n+    final safeLeft = padding.left + 8.0; // Add some padding\n+    final safeRight = screenSize.width - padding.right - 8.0;\n \n-    // Calculate menu position (below the selection)\n+    debugPrint('Selection rect: $selectionRect');\n+    debugPrint('Screen size: $screenSize, Safe area: top=$safeTop, bottom=$safeBottom');\n+\n+    // Estimated menu dimensions (will be constrained by actual content)\n+    const estimatedMenuHeight = 150.0; // 3 items * ~50px each\n+    const estimatedMenuWidth = 150.0; // Approximate width\n+\n+    // Calculate initial position (below and centered on selection)\n     double menuTop = selectionRect.bottom + 8;\n-    double menuLeft = selectionRect.left;\n+    double menuLeft = selectionRect.left + (selectionRect.width / 2) - (estimatedMenuWidth / 2);\n \n-    debugPrint('Menu position - top: $menuTop, left: $menuLeft');\n-    debugPrint('Selection rect: $selectionRect');\n-    debugPrint('Screen size: $screenSize');\n-\n-    // Ensure menu stays within screen bounds\n-    const menuHeight = 200.0; // Approximate height\n-    if (menuTop + menuHeight > screenSize.height) {\n-      // Show above selection if not enough space below\n-      menuTop = selectionRect.top - menuHeight - 8;\n+    // Vertical positioning: check if menu fits below selection\n+    if (menuTop + estimatedMenuHeight > safeBottom) {\n+      // Not enough space below, try above\n+      menuTop = selectionRect.top - estimatedMenuHeight - 8;\n+      \n+      // If still doesn't fit above, position at bottom of safe area\n+      if (menuTop < safeTop) {\n+        menuTop = safeBottom - estimatedMenuHeight - 8;\n+      }\n     }\n+    \n+    // Ensure menu doesn't go above safe area\n+    if (menuTop < safeTop) {\n+      menuTop = safeTop + 8;\n+    }\n \n-    // Ensure horizontal position is within bounds\n-    const menuWidth = 200.0; // Approximate width\n-    if (menuLeft + menuWidth > screenSize.width) {\n-      menuLeft = screenSize.width - menuWidth - 16;\n+    // Horizontal positioning: ensure menu stays within safe bounds\n+    if (menuLeft < safeLeft) {\n+      // Too far left, align to left edge\n+      menuLeft = safeLeft;\n+    } else if (menuLeft + estimatedMenuWidth > safeRight) {\n+      // Too far right, align to right edge\n+      menuLeft = safeRight - estimatedMenuWidth;\n     }\n-    if (menuLeft < 0) {\n-      menuLeft = 16;\n+    \n+    // Final check: if menu is still too wide, ensure at least it starts from safe area\n+    if (menuLeft < safeLeft) {\n+      menuLeft = safeLeft;\n     }\n \n+    debugPrint('Final menu position - top: $menuTop, left: $menuLeft');\n+\n     return Positioned(\n       top: menuTop,\n       left: menuLeft,\n       child: Material(\n@@ -145,9 +171,9 @@\n             border: Border.all(color: Colors.grey.shade300),\n           ),\n           constraints: BoxConstraints(\n             minWidth: 120,\n-            maxWidth: screenSize.width * 0.6,\n+            maxWidth: safeRight - safeLeft, // Use full safe width if needed\n           ),\n           child: IntrinsicWidth(\n             child: Column(\n               mainAxisSize: MainAxisSize.min,\n"
                },
                {
                    "date": 1762672815274,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -106,37 +106,40 @@\n \n   Widget _buildMenu(BuildContext context) {\n     final screenSize = MediaQuery.of(context).size;\n     final padding = MediaQuery.of(context).padding;\n-    \n+\n     // Account for system UI (status bar, navigation bar, etc.)\n     final safeTop = padding.top;\n     final safeBottom = screenSize.height - padding.bottom;\n     final safeLeft = padding.left + 8.0; // Add some padding\n     final safeRight = screenSize.width - padding.right - 8.0;\n \n     debugPrint('Selection rect: $selectionRect');\n-    debugPrint('Screen size: $screenSize, Safe area: top=$safeTop, bottom=$safeBottom');\n+    debugPrint(\n+        'Screen size: $screenSize, Safe area: top=$safeTop, bottom=$safeBottom');\n \n     // Estimated menu dimensions (will be constrained by actual content)\n     const estimatedMenuHeight = 150.0; // 3 items * ~50px each\n     const estimatedMenuWidth = 150.0; // Approximate width\n \n     // Calculate initial position (below and centered on selection)\n     double menuTop = selectionRect.bottom + 8;\n-    double menuLeft = selectionRect.left + (selectionRect.width / 2) - (estimatedMenuWidth / 2);\n+    double menuLeft = selectionRect.left +\n+        (selectionRect.width / 2) -\n+        (estimatedMenuWidth / 2);\n \n     // Vertical positioning: check if menu fits below selection\n     if (menuTop + estimatedMenuHeight > safeBottom) {\n       // Not enough space below, try above\n       menuTop = selectionRect.top - estimatedMenuHeight - 8;\n-      \n+\n       // If still doesn't fit above, position at bottom of safe area\n       if (menuTop < safeTop) {\n         menuTop = safeBottom - estimatedMenuHeight - 8;\n       }\n     }\n-    \n+\n     // Ensure menu doesn't go above safe area\n     if (menuTop < safeTop) {\n       menuTop = safeTop + 8;\n     }\n@@ -148,9 +151,9 @@\n     } else if (menuLeft + estimatedMenuWidth > safeRight) {\n       // Too far right, align to right edge\n       menuLeft = safeRight - estimatedMenuWidth;\n     }\n-    \n+\n     // Final check: if menu is still too wide, ensure at least it starts from safe area\n     if (menuLeft < safeLeft) {\n       menuLeft = safeLeft;\n     }\n"
                },
                {
                    "date": 1762673596943,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -163,16 +163,20 @@\n     return Positioned(\n       top: menuTop,\n       left: menuLeft,\n       child: Material(\n-        color: Colors.white,\n-        elevation: 8,\n-        borderRadius: BorderRadius.circular(8),\n+        color: Colors.transparent,\n         child: Container(\n           decoration: BoxDecoration(\n-            color: Colors.white,\n-            borderRadius: BorderRadius.circular(8),\n-            border: Border.all(color: Colors.grey.shade300),\n+            color: const Color(0xFF2C2C2E), // Dark background like iOS/Figma\n+            borderRadius: BorderRadius.circular(12),\n+            boxShadow: [\n+              BoxShadow(\n+                color: Colors.black.withOpacity(0.3),\n+                blurRadius: 16,\n+                offset: const Offset(0, 4),\n+              ),\n+            ],\n           ),\n           constraints: BoxConstraints(\n             minWidth: 120,\n             maxWidth: safeRight - safeLeft, // Use full safe width if needed\n@@ -186,10 +190,11 @@\n                 _MenuItemButton(\n                   icon: Icons.copy,\n                   label: '复制',\n                   onTap: onCopy,\n+                  isFirst: true,\n                 ),\n-                const Divider(height: 1),\n+                const _MenuDivider(),\n \n                 // Highlight/Remove Highlight button\n                 _MenuItemButton(\n                   icon: hasHighlight\n@@ -197,15 +202,16 @@\n                       : Icons.format_underlined,\n                   label: hasHighlight ? '删除划线' : '划线',\n                   onTap: hasHighlight ? onRemoveHighlight : onHighlight,\n                 ),\n-                const Divider(height: 1),\n+                const _MenuDivider(),\n \n                 // Note button\n                 _MenuItemButton(\n                   icon: Icons.edit_note,\n                   label: '笔记',\n                   onTap: onAddNote,\n+                  isLast: true,\n                 ),\n               ],\n             ),\n           ),\n@@ -219,35 +225,69 @@\n class _MenuItemButton extends StatelessWidget {\n   final IconData icon;\n   final String label;\n   final VoidCallback onTap;\n+  final bool isFirst;\n+  final bool isLast;\n \n   const _MenuItemButton({\n     super.key,\n     required this.icon,\n     required this.label,\n     required this.onTap,\n+    this.isFirst = false,\n+    this.isLast = false,\n   });\n \n   @override\n   Widget build(BuildContext context) {\n-    return InkWell(\n-      onTap: onTap,\n-      child: Padding(\n-        padding: const EdgeInsets.symmetric(\n-          horizontal: 16,\n-          vertical: 12,\n+    return Material(\n+      color: Colors.transparent,\n+      child: InkWell(\n+        onTap: onTap,\n+        borderRadius: BorderRadius.vertical(\n+          top: isFirst ? const Radius.circular(12) : Radius.zero,\n+          bottom: isLast ? const Radius.circular(12) : Radius.zero,\n         ),\n-        child: Row(\n-          children: [\n-            Icon(icon, size: 20),\n-            const SizedBox(width: 12),\n-            Text(\n-              label,\n-              style: const TextStyle(fontSize: 15),\n-            ),\n-          ],\n+        child: Padding(\n+          padding: const EdgeInsets.symmetric(\n+            horizontal: 16,\n+            vertical: 12,\n+          ),\n+          child: Row(\n+            mainAxisSize: MainAxisSize.min,\n+            children: [\n+              Icon(\n+                icon,\n+                size: 20,\n+                color: Colors.white,\n+              ),\n+              const SizedBox(width: 12),\n+              Text(\n+                label,\n+                style: const TextStyle(\n+                  fontSize: 15,\n+                  color: Colors.white,\n+                  fontWeight: FontWeight.w500,\n+                ),\n+              ),\n+            ],\n+          ),\n         ),\n       ),\n     );\n   }\n }\n+\n+/// Divider between menu items\n+class _MenuDivider extends StatelessWidget {\n+  const _MenuDivider();\n+\n+  @override\n+  Widget build(BuildContext context) {\n+    return Container(\n+      height: 1,\n+      margin: const EdgeInsets.symmetric(horizontal: 8),\n+      color: Colors.white.withOpacity(0.1),\n+    );\n+  }\n+}\n"
                },
                {
                    "date": 1762673824708,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -117,11 +117,11 @@\n     debugPrint('Selection rect: $selectionRect');\n     debugPrint(\n         'Screen size: $screenSize, Safe area: top=$safeTop, bottom=$safeBottom');\n \n-    // Estimated menu dimensions (will be constrained by actual content)\n-    const estimatedMenuHeight = 150.0; // 3 items * ~50px each\n-    const estimatedMenuWidth = 150.0; // Approximate width\n+    // Estimated menu dimensions (horizontal layout: 3 items side by side)\n+    const estimatedMenuHeight = 70.0; // Icon + text + padding\n+    const estimatedMenuWidth = 250.0; // ~80px per item * 3 items\n \n     // Calculate initial position (below and centered on selection)\n     double menuTop = selectionRect.bottom + 8;\n     double menuLeft = selectionRect.left +\n@@ -176,16 +176,12 @@\n                 offset: const Offset(0, 4),\n               ),\n             ],\n           ),\n-          constraints: BoxConstraints(\n-            minWidth: 120,\n-            maxWidth: safeRight - safeLeft, // Use full safe width if needed\n-          ),\n-          child: IntrinsicWidth(\n-            child: Column(\n+          padding: const EdgeInsets.symmetric(horizontal: 4, vertical: 4),\n+          child: IntrinsicHeight(\n+            child: Row(\n               mainAxisSize: MainAxisSize.min,\n-              crossAxisAlignment: CrossAxisAlignment.stretch,\n               children: [\n                 // Copy button\n                 _MenuItemButton(\n                   icon: Icons.copy,\n@@ -243,30 +239,31 @@\n     return Material(\n       color: Colors.transparent,\n       child: InkWell(\n         onTap: onTap,\n-        borderRadius: BorderRadius.vertical(\n-          top: isFirst ? const Radius.circular(12) : Radius.zero,\n-          bottom: isLast ? const Radius.circular(12) : Radius.zero,\n+        borderRadius: BorderRadius.horizontal(\n+          left: isFirst ? const Radius.circular(12) : Radius.zero,\n+          right: isLast ? const Radius.circular(12) : Radius.zero,\n         ),\n         child: Padding(\n           padding: const EdgeInsets.symmetric(\n             horizontal: 16,\n-            vertical: 12,\n+            vertical: 10,\n           ),\n-          child: Row(\n+          child: Column(\n             mainAxisSize: MainAxisSize.min,\n+            mainAxisAlignment: MainAxisAlignment.center,\n             children: [\n               Icon(\n                 icon,\n-                size: 20,\n+                size: 24,\n                 color: Colors.white,\n               ),\n-              const SizedBox(width: 12),\n+              const SizedBox(height: 4),\n               Text(\n                 label,\n                 style: const TextStyle(\n-                  fontSize: 15,\n+                  fontSize: 12,\n                   color: Colors.white,\n                   fontWeight: FontWeight.w500,\n                 ),\n               ),\n@@ -277,17 +274,17 @@\n     );\n   }\n }\n \n-/// Divider between menu items\n+/// Divider between menu items (vertical)\n class _MenuDivider extends StatelessWidget {\n   const _MenuDivider();\n \n   @override\n   Widget build(BuildContext context) {\n     return Container(\n-      height: 1,\n-      margin: const EdgeInsets.symmetric(horizontal: 8),\n-      color: Colors.white.withOpacity(0.1),\n+      width: 1,\n+      margin: const EdgeInsets.symmetric(vertical: 8),\n+      color: Colors.white.withOpacity(0.2),\n     );\n   }\n }\n"
                },
                {
                    "date": 1762673998939,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,8 +14,11 @@\n     required VoidCallback onHighlight,\n     required VoidCallback onRemoveHighlight,\n     required VoidCallback onAddNote,\n     required VoidCallback onCopy,\n+    required VoidCallback onSearch,\n+    required VoidCallback onListen,\n+    required VoidCallback onReport,\n   }) {\n     // Remove existing overlay if any\n     hide();\n \n@@ -38,8 +41,20 @@\n         onCopy: () {\n           hide();\n           onCopy();\n         },\n+        onSearch: () {\n+          hide();\n+          onSearch();\n+        },\n+        onListen: () {\n+          hide();\n+          onListen();\n+        },\n+        onReport: () {\n+          hide();\n+          onReport();\n+        },\n         onDismiss: hide,\n       ),\n     );\n \n@@ -64,8 +79,11 @@\n   final VoidCallback onHighlight;\n   final VoidCallback onRemoveHighlight;\n   final VoidCallback onAddNote;\n   final VoidCallback onCopy;\n+  final VoidCallback onSearch;\n+  final VoidCallback onListen;\n+  final VoidCallback onReport;\n   final VoidCallback onDismiss;\n \n   const SelectionContextMenuWidget({\n     super.key,\n@@ -74,8 +92,11 @@\n     required this.onHighlight,\n     required this.onRemoveHighlight,\n     required this.onAddNote,\n     required this.onCopy,\n+    required this.onSearch,\n+    required this.onListen,\n+    required this.onReport,\n     required this.onDismiss,\n   });\n \n   @override\n@@ -117,11 +138,11 @@\n     debugPrint('Selection rect: $selectionRect');\n     debugPrint(\n         'Screen size: $screenSize, Safe area: top=$safeTop, bottom=$safeBottom');\n \n-    // Estimated menu dimensions (horizontal layout: 3 items side by side)\n+    // Estimated menu dimensions (horizontal layout: 6 items side by side)\n     const estimatedMenuHeight = 70.0; // Icon + text + padding\n-    const estimatedMenuWidth = 250.0; // ~80px per item * 3 items\n+    const estimatedMenuWidth = 480.0; // ~80px per item * 6 items\n \n     // Calculate initial position (below and centered on selection)\n     double menuTop = selectionRect.bottom + 8;\n     double menuLeft = selectionRect.left +\n@@ -190,23 +211,45 @@\n                   isFirst: true,\n                 ),\n                 const _MenuDivider(),\n \n+                // Note button\n+                _MenuItemButton(\n+                  icon: Icons.edit_note,\n+                  label: '笔记',\n+                  onTap: onAddNote,\n+                ),\n+                const _MenuDivider(),\n+\n                 // Highlight/Remove Highlight button\n                 _MenuItemButton(\n-                  icon: hasHighlight\n-                      ? Icons.format_underlined\n-                      : Icons.format_underlined,\n+                  icon: hasHighlight ? Icons.highlight_remove : Icons.format_underlined,\n                   label: hasHighlight ? '删除划线' : '划线',\n                   onTap: hasHighlight ? onRemoveHighlight : onHighlight,\n                 ),\n                 const _MenuDivider(),\n \n-                // Note button\n+                // Search button\n                 _MenuItemButton(\n-                  icon: Icons.edit_note,\n-                  label: '笔记',\n-                  onTap: onAddNote,\n+                  icon: Icons.search,\n+                  label: '查询',\n+                  onTap: onSearch,\n+                ),\n+                const _MenuDivider(),\n+\n+                // Listen button\n+                _MenuItemButton(\n+                  icon: Icons.hearing,\n+                  label: '听当前',\n+                  onTap: onListen,\n+                ),\n+                const _MenuDivider(),\n+\n+                // Report button\n+                _MenuItemButton(\n+                  icon: Icons.flag_outlined,\n+                  label: '纠错',\n+                  onTap: onReport,\n                   isLast: true,\n                 ),\n               ],\n             ),\n"
                },
                {
                    "date": 1762674046860,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -221,9 +221,11 @@\n                 const _MenuDivider(),\n \n                 // Highlight/Remove Highlight button\n                 _MenuItemButton(\n-                  icon: hasHighlight ? Icons.highlight_remove : Icons.format_underlined,\n+                  icon: hasHighlight\n+                      ? Icons.highlight_remove\n+                      : Icons.format_underlined,\n                   label: hasHighlight ? '删除划线' : '划线',\n                   onTap: hasHighlight ? onRemoveHighlight : onHighlight,\n                 ),\n                 const _MenuDivider(),\n"
                },
                {
                    "date": 1763217734495,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -144,8 +144,9 @@\n     const estimatedMenuWidth = 480.0; // ~80px per item * 6 items\n \n     // Calculate initial position (below and centered on selection)\n     double menuTop = selectionRect.bottom + 8;\n+    debugPrint('menuTop: $menuTop');\n     double menuLeft = selectionRect.left +\n         (selectionRect.width / 2) -\n         (estimatedMenuWidth / 2);\n \n"
                },
                {
                    "date": 1763217802040,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -143,9 +143,9 @@\n     const estimatedMenuHeight = 70.0; // Icon + text + padding\n     const estimatedMenuWidth = 480.0; // ~80px per item * 6 items\n \n     // Calculate initial position (below and centered on selection)\n-    double menuTop = selectionRect.bottom + 8;\n+    double menuTop = max(selectionRect.bottom,selectionRect.top) + 8;\n     debugPrint('menuTop: $menuTop');\n     double menuLeft = selectionRect.left +\n         (selectionRect.width / 2) -\n         (estimatedMenuWidth / 2);\n"
                },
                {
                    "date": 1763217809417,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,6 @@\n+import 'dart:math';\n+\n import 'package:flutter/material.dart';\n \n /// Custom context menu for text selection in EPUB viewer\n class SelectionContextMenu {\n"
                },
                {
                    "date": 1763217867590,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -147,8 +147,10 @@\n \n     // Calculate initial position (below and centered on selection)\n     double menuTop = max(selectionRect.bottom, selectionRect.top) + 8;\n     debugPrint('menuTop: $menuTop');\n+    debugPrint('selectionRect.bottom: ${selectionRect.bottom}');\n+    debugPrint('selectionRect.top: ${selectionRect.top}');\n     double menuLeft = selectionRect.left +\n         (selectionRect.width / 2) -\n         (estimatedMenuWidth / 2);\n \n"
                }
            ],
            "date": 1762672478354,
            "name": "Commit-0",
            "content": "import 'package:flutter/material.dart';\n\n/// Custom context menu for text selection in EPUB viewer\nclass SelectionContextMenu {\n  OverlayEntry? _overlayEntry;\n  final BuildContext context;\n\n  SelectionContextMenu(this.context);\n\n  /// Show the context menu at the specified position\n  void show({\n    required Rect selectionRect,\n    required bool hasHighlight,\n    required VoidCallback onHighlight,\n    required VoidCallback onRemoveHighlight,\n    required VoidCallback onAddNote,\n    required VoidCallback onCopy,\n  }) {\n    // Remove existing overlay if any\n    hide();\n\n    _overlayEntry = OverlayEntry(\n      builder: (context) => SelectionContextMenuWidget(\n        selectionRect: selectionRect,\n        hasHighlight: hasHighlight,\n        onHighlight: () {\n          hide();\n          onHighlight();\n        },\n        onRemoveHighlight: () {\n          hide();\n          onRemoveHighlight();\n        },\n        onAddNote: () {\n          hide();\n          onAddNote();\n        },\n        onCopy: () {\n          hide();\n          onCopy();\n        },\n        onDismiss: hide,\n      ),\n    );\n\n    Overlay.of(context).insert(_overlayEntry!);\n    debugPrint('自定义的contextMenu显示了');\n  }\n\n  /// Hide and remove the context menu\n  void hide() {\n    _overlayEntry?.remove();\n    _overlayEntry = null;\n  }\n\n  /// Check if menu is currently showing\n  bool get isShowing => _overlayEntry != null;\n}\n\n/// The actual widget for the context menu\nclass SelectionContextMenuWidget extends StatelessWidget {\n  final Rect selectionRect;\n  final bool hasHighlight;\n  final VoidCallback onHighlight;\n  final VoidCallback onRemoveHighlight;\n  final VoidCallback onAddNote;\n  final VoidCallback onCopy;\n  final VoidCallback onDismiss;\n\n  const SelectionContextMenuWidget({\n    Key? key,\n    required this.selectionRect,\n    required this.hasHighlight,\n    required this.onHighlight,\n    required this.onRemoveHighlight,\n    required this.onAddNote,\n    required this.onCopy,\n    required this.onDismiss,\n  }) : super(key: key);\n\n  @override\n  Widget build(BuildContext context) {\n    return Stack(\n      children: [\n        // Invisible barrier to detect taps outside the menu\n        Positioned.fill(\n          child: GestureDetector(\n            onTap: onDismiss,\n            behavior: HitTestBehavior.translucent,\n            child: Container(\n              color: Colors.transparent,\n            ),\n          ),\n        ),\n        // The actual menu\n        _buildMenu(context),\n      ],\n    );\n  }\n\n  Widget _buildMenu(BuildContext context) {\n    final screenSize = MediaQuery.of(context).size;\n    \n    // Calculate menu position (below the selection)\n    double menuTop = selectionRect.bottom + 8;\n    double menuLeft = selectionRect.left;\n    \n    // Ensure menu stays within screen bounds\n    const menuHeight = 200.0; // Approximate height\n    if (menuTop + menuHeight > screenSize.height) {\n      // Show above selection if not enough space below\n      menuTop = selectionRect.top - menuHeight - 8;\n    }\n    \n    // Ensure horizontal position is within bounds\n    const menuWidth = 200.0; // Approximate width\n    if (menuLeft + menuWidth > screenSize.width) {\n      menuLeft = screenSize.width - menuWidth - 16;\n    }\n    if (menuLeft < 0) {\n      menuLeft = 16;\n    }\n\n    return Positioned(\n      top: menuTop,\n      left: menuLeft,\n      child: Material(\n        elevation: 8,\n        borderRadius: BorderRadius.circular(8),\n        child: Container(\n          constraints: BoxConstraints(\n            minWidth: 120,\n            maxWidth: screenSize.width * 0.6,\n          ),\n          child: IntrinsicWidth(\n            child: Column(\n              mainAxisSize: MainAxisSize.min,\n              crossAxisAlignment: CrossAxisAlignment.stretch,\n              children: [\n                // Copy button\n                _MenuItemButton(\n                  icon: Icons.copy,\n                  label: '复制',\n                  onTap: onCopy,\n                ),\n                const Divider(height: 1),\n                \n                // Highlight/Remove Highlight button\n                _MenuItemButton(\n                  icon: hasHighlight ? Icons.format_underlined : Icons.format_underlined,\n                  label: hasHighlight ? '删除划线' : '划线',\n                  onTap: hasHighlight ? onRemoveHighlight : onHighlight,\n                ),\n                const Divider(height: 1),\n                \n                // Note button\n                _MenuItemButton(\n                  icon: Icons.edit_note,\n                  label: '笔记',\n                  onTap: onAddNote,\n                ),\n              ],\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n/// Individual menu item button\nclass _MenuItemButton extends StatelessWidget {\n  final IconData icon;\n  final String label;\n  final VoidCallback onTap;\n\n  const _MenuItemButton({\n    Key? key,\n    required this.icon,\n    required this.label,\n    required this.onTap,\n  }) : super(key: key);\n\n  @override\n  Widget build(BuildContext context) {\n    return InkWell(\n      onTap: onTap,\n      child: Padding(\n        padding: const EdgeInsets.symmetric(\n          horizontal: 16,\n          vertical: 12,\n        ),\n        child: Row(\n          children: [\n            Icon(icon, size: 20),\n            const SizedBox(width: 12),\n            Text(\n              label,\n              style: const TextStyle(fontSize: 15),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n\n"
        }
    ]
}