{
    "sourceFile": "example/lib/main.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 30,
            "patches": [
                {
                    "date": 1762656180806,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1762656202065,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,161 @@\n+import 'package:flutter/material.dart';\n+import 'package:flutter_epub_viewer/flutter_epub_viewer.dart';\n+\n+import 'chapter_drawer.dart';\n+\n+void main() {\n+  runApp(const MyApp());\n+}\n+\n+class MyApp extends StatelessWidget {\n+  const MyApp({super.key});\n+\n+  // This widget is the root of your application.\n+  @override\n+  Widget build(BuildContext context) {\n+    return MaterialApp(\n+      title: 'Flutter Demo',\n+      theme: ThemeData(\n+        // This is the theme of your application.\n+        //\n+        // TRY THIS: Try running your application with \"flutter run\". You'll see\n+        // the application has a purple toolbar. Then, without quitting the app,\n+        // try changing the seedColor in the colorScheme below to Colors.green\n+        // and then invoke \"hot reload\" (save your changes or press the \"hot\n+        // reload\" button in a Flutter-supported IDE, or press \"r\" if you used\n+        // the command line to start the app).\n+        //\n+        // Notice that the counter didn't reset back to zero; the application\n+        // state is not lost during the reload. To reset the state, use hot\n+        // restart instead.\n+        //\n+        // This works for code too, not just values: Most code changes can be\n+        // tested with just a hot reload.\n+        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),\n+        useMaterial3: true,\n+      ),\n+      home: const MyHomePage(title: 'Epub Viewer Demo'),\n+    );\n+  }\n+}\n+\n+class MyHomePage extends StatefulWidget {\n+  const MyHomePage({super.key, required this.title});\n+\n+  final String title;\n+\n+  @override\n+  State<MyHomePage> createState() => _MyHomePageState();\n+}\n+\n+class _MyHomePageState extends State<MyHomePage> {\n+  final epubController = EpubController();\n+\n+  var textSelectionCfi = '';\n+\n+  bool isLoading = true;\n+\n+  double progress = 0.0;\n+\n+  @override\n+  Widget build(BuildContext context) {\n+    return Scaffold(\n+      drawer: ChapterDrawer(controller: epubController),\n+      appBar: AppBar(\n+        backgroundColor: Theme.of(context).colorScheme.inversePrimary,\n+        title: Text(widget.title),\n+        actions: [\n+          IconButton(\n+            icon: const Icon(Icons.search),\n+            onPressed: () {\n+              epubController.setFontSize(fontSize: 35);\n+            },\n+          ),\n+        ],\n+      ),\n+      body: SafeArea(\n+        child: Column(\n+          children: [\n+            LinearProgressIndicator(\n+              value: progress,\n+              backgroundColor: Colors.transparent,\n+            ),\n+            Expanded(\n+              child: Stack(\n+                children: [\n+                  EpubViewer(\n+                    initialCfi: 'epubcfi(/6/20!/4/2[introduction]/2[c1_h]/1:0)',\n+                    epubSource: EpubSource.fromUrl(\n+                      'https://github.com/IDPF/epub3-samples/releases/download/20230704/accessible_epub_3.epub',\n+                    ),\n+                    epubController: epubController,\n+                    displaySettings: EpubDisplaySettings(\n+                      flow: EpubFlow.paginated,\n+                      useSnapAnimationAndroid: false,\n+                      snap: true,\n+                      theme: EpubTheme.light(),\n+                      allowScriptedContent: true,\n+                    ),\n+                    selectionContextMenu: ContextMenu(\n+                      menuItems: [\n+                        ContextMenuItem(\n+                          title: \"Highlight\",\n+                          id: 1,\n+                          action: () async {\n+                            epubController.addHighlight(cfi: textSelectionCfi);\n+                          },\n+                        ),\n+                      ],\n+                      settings: ContextMenuSettings(\n+                        hideDefaultSystemContextMenuItems: true,\n+                      ),\n+                    ),\n+                    onChaptersLoaded: (chapters) {\n+                      setState(() {\n+                        isLoading = false;\n+                      });\n+                    },\n+                    onEpubLoaded: () async {\n+                      print('Epub loaded');\n+                    },\n+                    onRelocated: (value) {\n+                      print(\"Reloacted to $value\");\n+                      setState(() {\n+                        progress = value.progress;\n+                      });\n+                    },\n+                    onAnnotationClicked: (cfi) {\n+                      print(\"Annotation clicked $cfi\");\n+                    },\n+                    onTextSelected: (epubTextSelection) {\n+                      textSelectionCfi = epubTextSelection.selectionCfi;\n+                      print(textSelectionCfi);\n+                    },\n+                    onLocationLoaded: () {\n+                      /// progress will be available after this callback\n+                      print('on location loaded');\n+                    },\n+                    onSelection:\n+                        (selectedText, cfiRange, selectionRect, viewRect) {\n+                          print(\"On selection changes\");\n+                        },\n+                    onDeselection: () {\n+                      print(\"on delection\");\n+                    },\n+                    onSelectionChanging: () {\n+                      print(\"on slection chnages\");\n+                    },\n+                  ),\n+                  Visibility(\n+                    visible: isLoading,\n+                    child: const Center(child: CircularProgressIndicator()),\n+                  ),\n+                ],\n+              ),\n+            ),\n+          ],\n+        ),\n+      ),\n+    );\n+  }\n+}\n"
                },
                {
                    "date": 1762656249924,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -158,163 +158,4 @@\n       ),\n     );\n   }\n }\n-import 'package:flutter/material.dart';\n-import 'package:flutter_epub_viewer/flutter_epub_viewer.dart';\n-\n-void main() {\n-  runApp(const MyApp());\n-}\n-\n-class MyApp extends StatelessWidget {\n-  const MyApp({super.key});\n-\n-  // This widget is the root of your application.\n-  @override\n-  Widget build(BuildContext context) {\n-    return MaterialApp(\n-      title: 'Flutter Demo',\n-      theme: ThemeData(\n-        // This is the theme of your application.\n-        //\n-        // TRY THIS: Try running your application with \"flutter run\". You'll see\n-        // the application has a purple toolbar. Then, without quitting the app,\n-        // try changing the seedColor in the colorScheme below to Colors.green\n-        // and then invoke \"hot reload\" (save your changes or press the \"hot\n-        // reload\" button in a Flutter-supported IDE, or press \"r\" if you used\n-        // the command line to start the app).\n-        //\n-        // Notice that the counter didn't reset back to zero; the application\n-        // state is not lost during the reload. To reset the state, use hot\n-        // restart instead.\n-        //\n-        // This works for code too, not just values: Most code changes can be\n-        // tested with just a hot reload.\n-        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),\n-        useMaterial3: true,\n-      ),\n-      home: const MyHomePage(title: 'Epub Viewer Demo'),\n-    );\n-  }\n-}\n-\n-class MyHomePage extends StatefulWidget {\n-  const MyHomePage({super.key, required this.title});\n-\n-  final String title;\n-\n-  @override\n-  State<MyHomePage> createState() => _MyHomePageState();\n-}\n-\n-class _MyHomePageState extends State<MyHomePage> {\n-  final epubController = EpubController();\n-\n-  var textSelectionCfi = '';\n-\n-  bool isLoading = true;\n-\n-  double progress = 0.0;\n-\n-  @override\n-  Widget build(BuildContext context) {\n-    return Scaffold(\n-      drawer: ChapterDrawer(controller: epubController),\n-      appBar: AppBar(\n-        backgroundColor: Theme.of(context).colorScheme.inversePrimary,\n-        title: Text(widget.title),\n-        actions: [\n-          IconButton(\n-            icon: const Icon(Icons.search),\n-            onPressed: () {\n-              epubController.setFontSize(fontSize: 35);\n-            },\n-          ),\n-        ],\n-      ),\n-      body: SafeArea(\n-        child: Column(\n-          children: [\n-            LinearProgressIndicator(\n-              value: progress,\n-              backgroundColor: Colors.transparent,\n-            ),\n-            Expanded(\n-              child: Stack(\n-                children: [\n-                  EpubViewer(\n-                    initialCfi: 'epubcfi(/6/20!/4/2[introduction]/2[c1_h]/1:0)',\n-                    epubSource: EpubSource.fromUrl(\n-                      'https://github.com/IDPF/epub3-samples/releases/download/20230704/accessible_epub_3.epub',\n-                    ),\n-                    epubController: epubController,\n-                    displaySettings: EpubDisplaySettings(\n-                      flow: EpubFlow.paginated,\n-                      useSnapAnimationAndroid: false,\n-                      snap: true,\n-                      theme: EpubTheme.light(),\n-                      allowScriptedContent: true,\n-                    ),\n-                    selectionContextMenu: ContextMenu(\n-                      menuItems: [\n-                        ContextMenuItem(\n-                          title: \"Highlight\",\n-                          id: 1,\n-                          action: () async {\n-                            epubController.addHighlight(cfi: textSelectionCfi);\n-                          },\n-                        ),\n-                      ],\n-                      settings: ContextMenuSettings(\n-                        hideDefaultSystemContextMenuItems: true,\n-                      ),\n-                    ),\n-                    onChaptersLoaded: (chapters) {\n-                      setState(() {\n-                        isLoading = false;\n-                      });\n-                    },\n-                    onEpubLoaded: () async {\n-                      print('Epub loaded');\n-                    },\n-                    onRelocated: (value) {\n-                      print(\"Reloacted to $value\");\n-                      setState(() {\n-                        progress = value.progress;\n-                      });\n-                    },\n-                    onAnnotationClicked: (cfi) {\n-                      print(\"Annotation clicked $cfi\");\n-                    },\n-                    onTextSelected: (epubTextSelection) {\n-                      textSelectionCfi = epubTextSelection.selectionCfi;\n-                      print(textSelectionCfi);\n-                    },\n-                    onLocationLoaded: () {\n-                      /// progress will be available after this callback\n-                      print('on location loaded');\n-                    },\n-                    onSelection:\n-                        (selectedText, cfiRange, selectionRect, viewRect) {\n-                          print(\"On selection changes\");\n-                        },\n-                    onDeselection: () {\n-                      print(\"on delection\");\n-                    },\n-                    onSelectionChanging: () {\n-                      print(\"on slection chnages\");\n-                    },\n-                  ),\n-                  Visibility(\n-                    visible: isLoading,\n-                    child: const Center(child: CircularProgressIndicator()),\n-                  ),\n-                ],\n-              ),\n-            ),\n-          ],\n-        ),\n-      ),\n-    );\n-  }\n-}\n"
                },
                {
                    "date": 1762657250923,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,8 +104,50 @@\n                           action: () async {\n                             epubController.addHighlight(cfi: textSelectionCfi);\n                           },\n                         ),\n+                        ContextMenuItem(\n+                          title: \"Underline (Black)\",\n+                          id: 2,\n+                          action: () async {\n+                            epubController.addUnderline(\n+                              cfi: textSelectionCfi,\n+                              color: Colors.black,\n+                            );\n+                          },\n+                        ),\n+                        ContextMenuItem(\n+                          title: \"Underline (Red)\",\n+                          id: 3,\n+                          action: () async {\n+                            epubController.addUnderline(\n+                              cfi: textSelectionCfi,\n+                              color: Colors.red,\n+                            );\n+                          },\n+                        ),\n+                        ContextMenuItem(\n+                          title: \"Underline (Blue Dashed)\",\n+                          id: 4,\n+                          action: () async {\n+                            epubController.addUnderline(\n+                              cfi: textSelectionCfi,\n+                              color: Colors.blue,\n+                              isDashed: true,\n+                            );\n+                          },\n+                        ),\n+                        ContextMenuItem(\n+                          title: \"Underline (Green Dashed)\",\n+                          id: 5,\n+                          action: () async {\n+                            epubController.addUnderline(\n+                              cfi: textSelectionCfi,\n+                              color: Colors.green,\n+                              isDashed: true,\n+                            );\n+                          },\n+                        ),\n                       ],\n                       settings: ContextMenuSettings(\n                         hideDefaultSystemContextMenuItems: true,\n                       ),\n"
                },
                {
                    "date": 1762657301059,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,203 @@\n+import 'package:flutter/material.dart';\n+import 'package:flutter_epub_viewer/flutter_epub_viewer.dart';\n+\n+import 'chapter_drawer.dart';\n+\n+void main() {\n+  runApp(const MyApp());\n+}\n+\n+class MyApp extends StatelessWidget {\n+  const MyApp({super.key});\n+\n+  // This widget is the root of your application.\n+  @override\n+  Widget build(BuildContext context) {\n+    return MaterialApp(\n+      title: 'Flutter Demo',\n+      theme: ThemeData(\n+        // This is the theme of your application.\n+        //\n+        // TRY THIS: Try running your application with \"flutter run\". You'll see\n+        // the application has a purple toolbar. Then, without quitting the app,\n+        // try changing the seedColor in the colorScheme below to Colors.green\n+        // and then invoke \"hot reload\" (save your changes or press the \"hot\n+        // reload\" button in a Flutter-supported IDE, or press \"r\" if you used\n+        // the command line to start the app).\n+        //\n+        // Notice that the counter didn't reset back to zero; the application\n+        // state is not lost during the reload. To reset the state, use hot\n+        // restart instead.\n+        //\n+        // This works for code too, not just values: Most code changes can be\n+        // tested with just a hot reload.\n+        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),\n+        useMaterial3: true,\n+      ),\n+      home: const MyHomePage(title: 'Epub Viewer Demo'),\n+    );\n+  }\n+}\n+\n+class MyHomePage extends StatefulWidget {\n+  const MyHomePage({super.key, required this.title});\n+\n+  final String title;\n+\n+  @override\n+  State<MyHomePage> createState() => _MyHomePageState();\n+}\n+\n+class _MyHomePageState extends State<MyHomePage> {\n+  final epubController = EpubController();\n+\n+  var textSelectionCfi = '';\n+\n+  bool isLoading = true;\n+\n+  double progress = 0.0;\n+\n+  @override\n+  Widget build(BuildContext context) {\n+    return Scaffold(\n+      drawer: ChapterDrawer(controller: epubController),\n+      appBar: AppBar(\n+        backgroundColor: Theme.of(context).colorScheme.inversePrimary,\n+        title: Text(widget.title),\n+        actions: [\n+          IconButton(\n+            icon: const Icon(Icons.search),\n+            onPressed: () {\n+              epubController.setFontSize(fontSize: 35);\n+            },\n+          ),\n+        ],\n+      ),\n+      body: SafeArea(\n+        child: Column(\n+          children: [\n+            LinearProgressIndicator(\n+              value: progress,\n+              backgroundColor: Colors.transparent,\n+            ),\n+            Expanded(\n+              child: Stack(\n+                children: [\n+                  EpubViewer(\n+                    initialCfi: 'epubcfi(/6/20!/4/2[introduction]/2[c1_h]/1:0)',\n+                    epubSource: EpubSource.fromUrl(\n+                      'https://github.com/IDPF/epub3-samples/releases/download/20230704/accessible_epub_3.epub',\n+                    ),\n+                    epubController: epubController,\n+                    displaySettings: EpubDisplaySettings(\n+                      flow: EpubFlow.paginated,\n+                      useSnapAnimationAndroid: false,\n+                      snap: true,\n+                      theme: EpubTheme.light(),\n+                      allowScriptedContent: true,\n+                    ),\n+                    selectionContextMenu: ContextMenu(\n+                      menuItems: [\n+                        ContextMenuItem(\n+                          title: \"Highlight\",\n+                          id: 1,\n+                          action: () async {\n+                            epubController.addHighlight(cfi: textSelectionCfi);\n+                          },\n+                        ),\n+                        ContextMenuItem(\n+                          title: \"Underline (Black)\",\n+                          id: 2,\n+                          action: () async {\n+                            epubController.addUnderline(\n+                              cfi: textSelectionCfi,\n+                              color: Colors.black,\n+                            );\n+                          },\n+                        ),\n+                        ContextMenuItem(\n+                          title: \"Underline (Red)\",\n+                          id: 3,\n+                          action: () async {\n+                            epubController.addUnderline(\n+                              cfi: textSelectionCfi,\n+                              color: Colors.red,\n+                            );\n+                          },\n+                        ),\n+                        ContextMenuItem(\n+                          title: \"Underline (Blue Dashed)\",\n+                          id: 4,\n+                          action: () async {\n+                            epubController.addUnderline(\n+                              cfi: textSelectionCfi,\n+                              color: Colors.blue,\n+                              isDashed: true,\n+                            );\n+                          },\n+                        ),\n+                        ContextMenuItem(\n+                          title: \"Underline (Green Dashed)\",\n+                          id: 5,\n+                          action: () async {\n+                            epubController.addUnderline(\n+                              cfi: textSelectionCfi,\n+                              color: Colors.green,\n+                              isDashed: true,\n+                            );\n+                          },\n+                        ),\n+                      ],\n+                      settings: ContextMenuSettings(\n+                        hideDefaultSystemContextMenuItems: true,\n+                      ),\n+                    ),\n+                    onChaptersLoaded: (chapters) {\n+                      setState(() {\n+                        isLoading = false;\n+                      });\n+                    },\n+                    onEpubLoaded: () async {\n+                      print('Epub loaded');\n+                    },\n+                    onRelocated: (value) {\n+                      print(\"Reloacted to $value\");\n+                      setState(() {\n+                        progress = value.progress;\n+                      });\n+                    },\n+                    onAnnotationClicked: (cfi) {\n+                      print(\"Annotation clicked $cfi\");\n+                    },\n+                    onTextSelected: (epubTextSelection) {\n+                      textSelectionCfi = epubTextSelection.selectionCfi;\n+                      print(textSelectionCfi);\n+                    },\n+                    onLocationLoaded: () {\n+                      /// progress will be available after this callback\n+                      print('on location loaded');\n+                    },\n+                    onSelection:\n+                        (selectedText, cfiRange, selectionRect, viewRect) {\n+                          print(\"On selection changes\");\n+                        },\n+                    onDeselection: () {\n+                      print(\"on delection\");\n+                    },\n+                    onSelectionChanging: () {\n+                      print(\"on slection chnages\");\n+                    },\n+                  ),\n+                  Visibility(\n+                    visible: isLoading,\n+                    child: const Center(child: CircularProgressIndicator()),\n+                  ),\n+                ],\n+              ),\n+            ),\n+          ],\n+        ),\n+      ),\n+    );\n+  }\n+}\n"
                },
                {
                    "date": 1762657564994,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -83,11 +83,10 @@\n             Expanded(\n               child: Stack(\n                 children: [\n                   EpubViewer(\n-                    initialCfi: 'epubcfi(/6/20!/4/2[introduction]/2[c1_h]/1:0)',\n-                    epubSource: EpubSource.fromUrl(\n-                      'https://github.com/IDPF/epub3-samples/releases/download/20230704/accessible_epub_3.epub',\n+                    epubSource: EpubSource.fromAsset(\n+                      'assets/epubs/test.epub',\n                     ),\n                     epubController: epubController,\n                     displaySettings: EpubDisplaySettings(\n                       flow: EpubFlow.paginated,\n@@ -178,213 +177,10 @@\n                       print('on location loaded');\n                     },\n                     onSelection:\n                         (selectedText, cfiRange, selectionRect, viewRect) {\n-                          print(\"On selection changes\");\n-                        },\n-                    onDeselection: () {\n-                      print(\"on delection\");\n+                      print(\"On selection changes\");\n                     },\n-                    onSelectionChanging: () {\n-                      print(\"on slection chnages\");\n-                    },\n-                  ),\n-                  Visibility(\n-                    visible: isLoading,\n-                    child: const Center(child: CircularProgressIndicator()),\n-                  ),\n-                ],\n-              ),\n-            ),\n-          ],\n-        ),\n-      ),\n-    );\n-  }\n-}\n-import 'package:flutter/material.dart';\n-import 'package:flutter_epub_viewer/flutter_epub_viewer.dart';\n-\n-import 'chapter_drawer.dart';\n-\n-void main() {\n-  runApp(const MyApp());\n-}\n-\n-class MyApp extends StatelessWidget {\n-  const MyApp({super.key});\n-\n-  // This widget is the root of your application.\n-  @override\n-  Widget build(BuildContext context) {\n-    return MaterialApp(\n-      title: 'Flutter Demo',\n-      theme: ThemeData(\n-        // This is the theme of your application.\n-        //\n-        // TRY THIS: Try running your application with \"flutter run\". You'll see\n-        // the application has a purple toolbar. Then, without quitting the app,\n-        // try changing the seedColor in the colorScheme below to Colors.green\n-        // and then invoke \"hot reload\" (save your changes or press the \"hot\n-        // reload\" button in a Flutter-supported IDE, or press \"r\" if you used\n-        // the command line to start the app).\n-        //\n-        // Notice that the counter didn't reset back to zero; the application\n-        // state is not lost during the reload. To reset the state, use hot\n-        // restart instead.\n-        //\n-        // This works for code too, not just values: Most code changes can be\n-        // tested with just a hot reload.\n-        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),\n-        useMaterial3: true,\n-      ),\n-      home: const MyHomePage(title: 'Epub Viewer Demo'),\n-    );\n-  }\n-}\n-\n-class MyHomePage extends StatefulWidget {\n-  const MyHomePage({super.key, required this.title});\n-\n-  final String title;\n-\n-  @override\n-  State<MyHomePage> createState() => _MyHomePageState();\n-}\n-\n-class _MyHomePageState extends State<MyHomePage> {\n-  final epubController = EpubController();\n-\n-  var textSelectionCfi = '';\n-\n-  bool isLoading = true;\n-\n-  double progress = 0.0;\n-\n-  @override\n-  Widget build(BuildContext context) {\n-    return Scaffold(\n-      drawer: ChapterDrawer(controller: epubController),\n-      appBar: AppBar(\n-        backgroundColor: Theme.of(context).colorScheme.inversePrimary,\n-        title: Text(widget.title),\n-        actions: [\n-          IconButton(\n-            icon: const Icon(Icons.search),\n-            onPressed: () {\n-              epubController.setFontSize(fontSize: 35);\n-            },\n-          ),\n-        ],\n-      ),\n-      body: SafeArea(\n-        child: Column(\n-          children: [\n-            LinearProgressIndicator(\n-              value: progress,\n-              backgroundColor: Colors.transparent,\n-            ),\n-            Expanded(\n-              child: Stack(\n-                children: [\n-                  EpubViewer(\n-                    initialCfi: 'epubcfi(/6/20!/4/2[introduction]/2[c1_h]/1:0)',\n-                    epubSource: EpubSource.fromUrl(\n-                      'https://github.com/IDPF/epub3-samples/releases/download/20230704/accessible_epub_3.epub',\n-                    ),\n-                    epubController: epubController,\n-                    displaySettings: EpubDisplaySettings(\n-                      flow: EpubFlow.paginated,\n-                      useSnapAnimationAndroid: false,\n-                      snap: true,\n-                      theme: EpubTheme.light(),\n-                      allowScriptedContent: true,\n-                    ),\n-                    selectionContextMenu: ContextMenu(\n-                      menuItems: [\n-                        ContextMenuItem(\n-                          title: \"Highlight\",\n-                          id: 1,\n-                          action: () async {\n-                            epubController.addHighlight(cfi: textSelectionCfi);\n-                          },\n-                        ),\n-                        ContextMenuItem(\n-                          title: \"Underline (Black)\",\n-                          id: 2,\n-                          action: () async {\n-                            epubController.addUnderline(\n-                              cfi: textSelectionCfi,\n-                              color: Colors.black,\n-                            );\n-                          },\n-                        ),\n-                        ContextMenuItem(\n-                          title: \"Underline (Red)\",\n-                          id: 3,\n-                          action: () async {\n-                            epubController.addUnderline(\n-                              cfi: textSelectionCfi,\n-                              color: Colors.red,\n-                            );\n-                          },\n-                        ),\n-                        ContextMenuItem(\n-                          title: \"Underline (Blue Dashed)\",\n-                          id: 4,\n-                          action: () async {\n-                            epubController.addUnderline(\n-                              cfi: textSelectionCfi,\n-                              color: Colors.blue,\n-                              isDashed: true,\n-                            );\n-                          },\n-                        ),\n-                        ContextMenuItem(\n-                          title: \"Underline (Green Dashed)\",\n-                          id: 5,\n-                          action: () async {\n-                            epubController.addUnderline(\n-                              cfi: textSelectionCfi,\n-                              color: Colors.green,\n-                              isDashed: true,\n-                            );\n-                          },\n-                        ),\n-                      ],\n-                      settings: ContextMenuSettings(\n-                        hideDefaultSystemContextMenuItems: true,\n-                      ),\n-                    ),\n-                    onChaptersLoaded: (chapters) {\n-                      setState(() {\n-                        isLoading = false;\n-                      });\n-                    },\n-                    onEpubLoaded: () async {\n-                      print('Epub loaded');\n-                    },\n-                    onRelocated: (value) {\n-                      print(\"Reloacted to $value\");\n-                      setState(() {\n-                        progress = value.progress;\n-                      });\n-                    },\n-                    onAnnotationClicked: (cfi) {\n-                      print(\"Annotation clicked $cfi\");\n-                    },\n-                    onTextSelected: (epubTextSelection) {\n-                      textSelectionCfi = epubTextSelection.selectionCfi;\n-                      print(textSelectionCfi);\n-                    },\n-                    onLocationLoaded: () {\n-                      /// progress will be available after this callback\n-                      print('on location loaded');\n-                    },\n-                    onSelection:\n-                        (selectedText, cfiRange, selectionRect, viewRect) {\n-                          print(\"On selection changes\");\n-                        },\n                     onDeselection: () {\n                       print(\"on delection\");\n                     },\n                     onSelectionChanging: () {\n"
                },
                {
                    "date": 1762657737818,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n                       'assets/epubs/test.epub',\n                     ),\n                     epubController: epubController,\n                     displaySettings: EpubDisplaySettings(\n-                      flow: EpubFlow.paginated,\n+                      flow: EpubFlow.scrolled,\n                       useSnapAnimationAndroid: false,\n                       snap: true,\n                       theme: EpubTheme.light(),\n                       allowScriptedContent: true,\n"
                },
                {
                    "date": 1762657831894,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,13 +64,13 @@\n       appBar: AppBar(\n         backgroundColor: Theme.of(context).colorScheme.inversePrimary,\n         title: Text(widget.title),\n         actions: [\n-          IconButton(\n-            icon: const Icon(Icons.search),\n+          TextButton(\n             onPressed: () {\n               epubController.setFontSize(fontSize: 35);\n             },\n+            child: const Text('改字体'),\n           ),\n         ],\n       ),\n       body: SafeArea(\n"
                },
                {
                    "date": 1762657883417,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -55,8 +55,9 @@\n \n   bool isLoading = true;\n \n   double progress = 0.0;\n+  int fontSize = 16;\n \n   @override\n   Widget build(BuildContext context) {\n     return Scaffold(\n@@ -88,8 +89,9 @@\n                       'assets/epubs/test.epub',\n                     ),\n                     epubController: epubController,\n                     displaySettings: EpubDisplaySettings(\n+                      fontSize: fontSize,\n                       flow: EpubFlow.scrolled,\n                       useSnapAnimationAndroid: false,\n                       snap: true,\n                       theme: EpubTheme.light(),\n"
                },
                {
                    "date": 1762657902456,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,9 +67,9 @@\n         title: Text(widget.title),\n         actions: [\n           TextButton(\n             onPressed: () {\n-              epubController.setFontSize(fontSize: 35);\n+              epubController.setFontSize(fontSize: fontSize == 16 ? 35 : 16);\n             },\n             child: const Text('改字体'),\n           ),\n         ],\n"
                },
                {
                    "date": 1762657934380,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,9 +67,12 @@\n         title: Text(widget.title),\n         actions: [\n           TextButton(\n             onPressed: () {\n-              epubController.setFontSize(fontSize: fontSize == 16 ? 35 : 16);\n+              setState(() {\n+                fontSize = fontSize == 16 ? 35 : 16;\n+              });\n+              epubController.setFontSize(fontSize: fontSize.toDouble());\n             },\n             child: const Text('改字体'),\n           ),\n         ],\n"
                },
                {
                    "date": 1762657962778,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,11 +67,11 @@\n         title: Text(widget.title),\n         actions: [\n           TextButton(\n             onPressed: () {\n-              setState(() {\n-                fontSize = fontSize == 16 ? 35 : 16;\n-              });\n+              // setState(() {\n+              //   fontSize = fontSize == 16 ? 35 : 16;\n+              // });\n               epubController.setFontSize(fontSize: fontSize.toDouble());\n             },\n             child: const Text('改字体'),\n           ),\n"
                },
                {
                    "date": 1762658049099,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,12 +67,12 @@\n         title: Text(widget.title),\n         actions: [\n           TextButton(\n             onPressed: () {\n-              // setState(() {\n-              //   fontSize = fontSize == 16 ? 35 : 16;\n-              // });\n-              epubController.setFontSize(fontSize: fontSize.toDouble());\n+              setState(() {\n+                fontSize = fontSize == 16 ? 35 : 16;\n+              });\n+              // epubController.setFontSize(fontSize: fontSize.toDouble());\n             },\n             child: const Text('改字体'),\n           ),\n         ],\n"
                },
                {
                    "date": 1762658062870,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -70,9 +70,9 @@\n             onPressed: () {\n               setState(() {\n                 fontSize = fontSize == 16 ? 35 : 16;\n               });\n-              // epubController.setFontSize(fontSize: fontSize.toDouble());\n+              epubController.setFontSize(fontSize: fontSize.toDouble());\n             },\n             child: const Text('改字体'),\n           ),\n         ],\n"
                },
                {
                    "date": 1762658749899,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -109,29 +109,9 @@\n                             epubController.addHighlight(cfi: textSelectionCfi);\n                           },\n                         ),\n                         ContextMenuItem(\n-                          title: \"Underline (Black)\",\n-                          id: 2,\n-                          action: () async {\n-                            epubController.addUnderline(\n-                              cfi: textSelectionCfi,\n-                              color: Colors.black,\n-                            );\n-                          },\n-                        ),\n-                        ContextMenuItem(\n-                          title: \"Underline (Red)\",\n-                          id: 3,\n-                          action: () async {\n-                            epubController.addUnderline(\n-                              cfi: textSelectionCfi,\n-                              color: Colors.red,\n-                            );\n-                          },\n-                        ),\n-                        ContextMenuItem(\n-                          title: \"Underline (Blue Dashed)\",\n+                          title: \"Underline (red Dashed)\",\n                           id: 4,\n                           action: () async {\n                             epubController.addUnderline(\n                               cfi: textSelectionCfi,\n@@ -139,19 +119,8 @@\n                               isDashed: true,\n                             );\n                           },\n                         ),\n-                        ContextMenuItem(\n-                          title: \"Underline (Green Dashed)\",\n-                          id: 5,\n-                          action: () async {\n-                            epubController.addUnderline(\n-                              cfi: textSelectionCfi,\n-                              color: Colors.green,\n-                              isDashed: true,\n-                            );\n-                          },\n-                        ),\n                       ],\n                       settings: ContextMenuSettings(\n                         hideDefaultSystemContextMenuItems: true,\n                       ),\n"
                },
                {
                    "date": 1762658754973,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -114,9 +114,9 @@\n                           id: 4,\n                           action: () async {\n                             epubController.addUnderline(\n                               cfi: textSelectionCfi,\n-                              color: Colors.blue,\n+                              color: Colors.red,\n                               isDashed: true,\n                             );\n                           },\n                         ),\n"
                },
                {
                    "date": 1762659387679,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,18 @@\n import 'package:flutter_epub_viewer/flutter_epub_viewer.dart';\n \n import 'chapter_drawer.dart';\n \n+class AppAnnotation {\n+  final String cfi;\n+  final Color color;\n+  final bool isDashed;\n+  final String title;\n+  final int id;\n+  final VoidCallback action;\n+}\n+}\n+\n void main() {\n   runApp(const MyApp());\n }\n \n"
                },
                {
                    "date": 1762659472330,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,16 +3,32 @@\n \n import 'chapter_drawer.dart';\n \n class AppAnnotation {\n-  final String cfi;\n+  final String cfiContainingRange;\n   final Color color;\n   final bool isDashed;\n-  final String title;\n-  final int id;\n-  final VoidCallback action;\n+  final bool isHighlight;\n+  final String text;\n+\n+  AppAnnotation({\n+    required this.cfiContainingRange,\n+    required this.color,\n+    required this.isDashed,\n+    required this.isHighlight,\n+    required this.text,\n+  });\n+\n+  factory AppAnnotation.fromJson(Map<String, dynamic> json) {\n+    return AppAnnotation(\n+      cfiContainingRange: json['cfiContainingRange'],\n+      color: json['color'],\n+      isDashed: json['isDashed'],\n+      isHighlight: json['isHighlight'],\n+      text: json['text'],\n+    );\n+  }\n }\n-}\n \n void main() {\n   runApp(const MyApp());\n }\n"
                },
                {
                    "date": 1762659488010,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -26,8 +26,34 @@\n       isHighlight: json['isHighlight'],\n       text: json['text'],\n     );\n   }\n+\n+  Map<String, dynamic> toJson() {\n+    return {\n+      'cfiContainingRange': cfiContainingRange,\n+      'color': color,\n+      'isDashed': isDashed,\n+      'isHighlight': isHighlight,\n+      'text': text,\n+    };\n+  }\n+\n+  @override\n+  String toString() {\n+    return 'AppAnnotation(cfiContainingRange: $cfiContainingRange, color: $color, isDashed: $isDashed, isHighlight: $isHighlight, text: $text)';\n+  }\n+\n+  @override\n+  bool operator ==(Object other) {\n+    if (identical(this, other)) return true;\n+    return other is AppAnnotation &&\n+        other.cfiContainingRange == cfiContainingRange &&\n+        other.color == color &&\n+        other.isDashed == isDashed &&\n+        other.isHighlight == isHighlight &&\n+        other.text == text;\n+  }\n }\n \n void main() {\n   runApp(const MyApp());\n"
                },
                {
                    "date": 1762659584332,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,15 +8,17 @@\n   final Color color;\n   final bool isDashed;\n   final bool isHighlight;\n   final String text;\n+  final String id;\n \n   AppAnnotation({\n     required this.cfiContainingRange,\n     required this.color,\n     required this.isDashed,\n     required this.isHighlight,\n     required this.text,\n+    required this.id,\n   });\n \n   factory AppAnnotation.fromJson(Map<String, dynamic> json) {\n     return AppAnnotation(\n@@ -24,8 +26,9 @@\n       color: json['color'],\n       isDashed: json['isDashed'],\n       isHighlight: json['isHighlight'],\n       text: json['text'],\n+      id: json['id'],\n     );\n   }\n \n   Map<String, dynamic> toJson() {\n@@ -34,14 +37,15 @@\n       'color': color,\n       'isDashed': isDashed,\n       'isHighlight': isHighlight,\n       'text': text,\n+      'id': id,\n     };\n   }\n \n   @override\n   String toString() {\n-    return 'AppAnnotation(cfiContainingRange: $cfiContainingRange, color: $color, isDashed: $isDashed, isHighlight: $isHighlight, text: $text)';\n+    return 'AppAnnotation(cfiContainingRange: $cfiContainingRange, color: $color, isDashed: $isDashed, isHighlight: $isHighlight, text: $text, id: $id)';\n   }\n \n   @override\n   bool operator ==(Object other) {\n@@ -52,8 +56,14 @@\n         other.isDashed == isDashed &&\n         other.isHighlight == isHighlight &&\n         other.text == text;\n   }\n+\n+  @override\n+  int get hashCode {\n+    return cfiContainingRange.hashCode ^\n+  \n+  }\n }\n \n void main() {\n   runApp(const MyApp());\n"
                },
                {
                    "date": 1762659602970,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,13 +50,9 @@\n   @override\n   bool operator ==(Object other) {\n     if (identical(this, other)) return true;\n     return other is AppAnnotation &&\n-        other.cfiContainingRange == cfiContainingRange &&\n-        other.color == color &&\n-        other.isDashed == isDashed &&\n-        other.isHighlight == isHighlight &&\n-        other.text == text;\n+        other.id == id ;\n   }\n \n   @override\n   int get hashCode {\n"
                },
                {
                    "date": 1762659618541,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,15 +50,19 @@\n   @override\n   bool operator ==(Object other) {\n     if (identical(this, other)) return true;\n     return other is AppAnnotation &&\n-        other.id == id ;\n+        other.id == id &&\n+        other.cfiContainingRange == cfiContainingRange &&\n+        other.color == color &&\n+        other.isDashed == isDashed &&\n+        other.isHighlight == isHighlight &&\n+        other.text == text;\n   }\n \n   @override\n   int get hashCode {\n-    return cfiContainingRange.hashCode ^\n-  \n+    return id.hashCode;\n   }\n }\n \n void main() {\n"
                },
                {
                    "date": 1762660365851,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,238 @@\n+import 'package:flutter/material.dart';\n+import 'package:flutter_epub_viewer/flutter_epub_viewer.dart';\n+\n+import 'chapter_drawer.dart';\n+\n+class AppAnnotation {\n+  final String cfiContainingRange;\n+  final Color color;\n+  final bool isDashed;\n+  final bool isHighlight;\n+  final String text;\n+  final String id;\n+\n+  AppAnnotation({\n+    required this.cfiContainingRange,\n+    required this.color,\n+    required this.isDashed,\n+    required this.isHighlight,\n+    required this.text,\n+    required this.id,\n+  });\n+\n+  factory AppAnnotation.fromJson(Map<String, dynamic> json) {\n+    return AppAnnotation(\n+      cfiContainingRange: json['cfiContainingRange'],\n+      color: json['color'],\n+      isDashed: json['isDashed'],\n+      isHighlight: json['isHighlight'],\n+      text: json['text'],\n+      id: json['id'],\n+    );\n+  }\n+\n+  Map<String, dynamic> toJson() {\n+    return {\n+      'cfiContainingRange': cfiContainingRange,\n+      'color': color,\n+      'isDashed': isDashed,\n+      'isHighlight': isHighlight,\n+      'text': text,\n+      'id': id,\n+    };\n+  }\n+\n+  @override\n+  String toString() {\n+    return 'AppAnnotation(cfiContainingRange: $cfiContainingRange, color: $color, isDashed: $isDashed, isHighlight: $isHighlight, text: $text, id: $id)';\n+  }\n+\n+  @override\n+  bool operator ==(Object other) {\n+    if (identical(this, other)) return true;\n+    return other is AppAnnotation &&\n+        other.id == id &&\n+        other.cfiContainingRange == cfiContainingRange &&\n+        other.color == color &&\n+        other.isDashed == isDashed &&\n+        other.isHighlight == isHighlight &&\n+        other.text == text;\n+  }\n+\n+  @override\n+  int get hashCode {\n+    return id.hashCode;\n+  }\n+}\n+\n+void main() {\n+  runApp(const MyApp());\n+}\n+\n+class MyApp extends StatelessWidget {\n+  const MyApp({super.key});\n+\n+  // This widget is the root of your application.\n+  @override\n+  Widget build(BuildContext context) {\n+    return MaterialApp(\n+      title: 'Flutter Demo',\n+      theme: ThemeData(\n+        // This is the theme of your application.\n+        //\n+        // TRY THIS: Try running your application with \"flutter run\". You'll see\n+        // the application has a purple toolbar. Then, without quitting the app,\n+        // try changing the seedColor in the colorScheme below to Colors.green\n+        // and then invoke \"hot reload\" (save your changes or press the \"hot\n+        // reload\" button in a Flutter-supported IDE, or press \"r\" if you used\n+        // the command line to start the app).\n+        //\n+        // Notice that the counter didn't reset back to zero; the application\n+        // state is not lost during the reload. To reset the state, use hot\n+        // restart instead.\n+        //\n+        // This works for code too, not just values: Most code changes can be\n+        // tested with just a hot reload.\n+        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),\n+        useMaterial3: true,\n+      ),\n+      home: const MyHomePage(title: 'Epub Viewer Demo'),\n+    );\n+  }\n+}\n+\n+class MyHomePage extends StatefulWidget {\n+  const MyHomePage({super.key, required this.title});\n+\n+  final String title;\n+\n+  @override\n+  State<MyHomePage> createState() => _MyHomePageState();\n+}\n+\n+class _MyHomePageState extends State<MyHomePage> {\n+  final epubController = EpubController();\n+\n+  var textSelectionCfi = '';\n+\n+  bool isLoading = true;\n+\n+  double progress = 0.0;\n+  int fontSize = 16;\n+\n+  @override\n+  Widget build(BuildContext context) {\n+    return Scaffold(\n+      drawer: ChapterDrawer(controller: epubController),\n+      appBar: AppBar(\n+        backgroundColor: Theme.of(context).colorScheme.inversePrimary,\n+        title: Text(widget.title),\n+        actions: [\n+          TextButton(\n+            onPressed: () {\n+              setState(() {\n+                fontSize = fontSize == 16 ? 35 : 16;\n+              });\n+              epubController.setFontSize(fontSize: fontSize.toDouble());\n+            },\n+            child: const Text('改字体'),\n+          ),\n+        ],\n+      ),\n+      body: SafeArea(\n+        child: Column(\n+          children: [\n+            LinearProgressIndicator(\n+              value: progress,\n+              backgroundColor: Colors.transparent,\n+            ),\n+            Expanded(\n+              child: Stack(\n+                children: [\n+                  EpubViewer(\n+                    epubSource: EpubSource.fromAsset(\n+                      'assets/epubs/test.epub',\n+                    ),\n+                    epubController: epubController,\n+                    displaySettings: EpubDisplaySettings(\n+                      fontSize: fontSize,\n+                      flow: EpubFlow.scrolled,\n+                      useSnapAnimationAndroid: false,\n+                      snap: true,\n+                      theme: EpubTheme.light(),\n+                      allowScriptedContent: true,\n+                    ),\n+                    selectionContextMenu: ContextMenu(\n+                      menuItems: [\n+                        ContextMenuItem(\n+                          title: \"Highlight\",\n+                          id: 1,\n+                          action: () async {\n+                            epubController.addHighlight(cfi: textSelectionCfi);\n+                          },\n+                        ),\n+                        ContextMenuItem(\n+                          title: \"Underline\",\n+                          id: 4,\n+                          action: () async {\n+                            epubController.addUnderline(\n+                              cfi: textSelectionCfi,\n+                              color: Colors.red,\n+                              isDashed: true,\n+                            );\n+                          },\n+                        ),\n+                      ],\n+                      settings: ContextMenuSettings(\n+                        hideDefaultSystemContextMenuItems: true,\n+                      ),\n+                    ),\n+                    onChaptersLoaded: (chapters) {\n+                      setState(() {\n+                        isLoading = false;\n+                      });\n+                    },\n+                    onEpubLoaded: () async {\n+                      print('Epub loaded');\n+                    },\n+                    onRelocated: (value) {\n+                      print(\"Reloacted to $value\");\n+                      setState(() {\n+                        progress = value.progress;\n+                      });\n+                    },\n+                    onAnnotationClicked: (cfi) {\n+                      print(\"Annotation clicked $cfi\");\n+                    },\n+                    onTextSelected: (epubTextSelection) {\n+                      textSelectionCfi = epubTextSelection.selectionCfi;\n+                      print(textSelectionCfi);\n+                    },\n+                    onLocationLoaded: () {\n+                      /// progress will be available after this callback\n+                      print('on location loaded');\n+                    },\n+                    onSelection:\n+                        (selectedText, cfiRange, selectionRect, viewRect) {\n+                      print(\"On selection changes\");\n+                    },\n+                    onDeselection: () {\n+                      print(\"on delection\");\n+                    },\n+                    onSelectionChanging: () {\n+                      print(\"on slection chnages\");\n+                    },\n+                  ),\n+                  Visibility(\n+                    visible: isLoading,\n+                    child: const Center(child: CircularProgressIndicator()),\n+                  ),\n+                ],\n+              ),\n+            ),\n+          ],\n+        ),\n+      ),\n+    );\n+  }\n+}\n"
                },
                {
                    "date": 1762660461652,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,28 +4,29 @@\n import 'chapter_drawer.dart';\n \n class AppAnnotation {\n   final String cfiContainingRange;\n-  final Color color;\n-  final bool isDashed;\n+  final String? myNote;\n+  final String? othersNote;\n+\n   final bool isHighlight;\n   final String text;\n   final String id;\n \n   AppAnnotation({\n     required this.cfiContainingRange,\n-    required this.color,\n-    required this.isDashed,\n+    required this.myNote,\n+    required this.othersNote,\n     required this.isHighlight,\n     required this.text,\n     required this.id,\n   });\n \n   factory AppAnnotation.fromJson(Map<String, dynamic> json) {\n     return AppAnnotation(\n       cfiContainingRange: json['cfiContainingRange'],\n-      color: json['color'],\n-      isDashed: json['isDashed'],\n+      myNote: json['myNote'],\n+      othersNote: json['othersNote'],\n       isHighlight: json['isHighlight'],\n       text: json['text'],\n       id: json['id'],\n     );\n@@ -235,242 +236,4 @@\n       ),\n     );\n   }\n }\n-import 'package:flutter/material.dart';\n-import 'package:flutter_epub_viewer/flutter_epub_viewer.dart';\n-\n-import 'chapter_drawer.dart';\n-\n-class AppAnnotation {\n-  final String cfiContainingRange;\n-  final Color color;\n-  final bool isDashed;\n-  final bool isHighlight;\n-  final String text;\n-  final String id;\n-\n-  AppAnnotation({\n-    required this.cfiContainingRange,\n-    required this.color,\n-    required this.isDashed,\n-    required this.isHighlight,\n-    required this.text,\n-    required this.id,\n-  });\n-\n-  factory AppAnnotation.fromJson(Map<String, dynamic> json) {\n-    return AppAnnotation(\n-      cfiContainingRange: json['cfiContainingRange'],\n-      color: json['color'],\n-      isDashed: json['isDashed'],\n-      isHighlight: json['isHighlight'],\n-      text: json['text'],\n-      id: json['id'],\n-    );\n-  }\n-\n-  Map<String, dynamic> toJson() {\n-    return {\n-      'cfiContainingRange': cfiContainingRange,\n-      'color': color,\n-      'isDashed': isDashed,\n-      'isHighlight': isHighlight,\n-      'text': text,\n-      'id': id,\n-    };\n-  }\n-\n-  @override\n-  String toString() {\n-    return 'AppAnnotation(cfiContainingRange: $cfiContainingRange, color: $color, isDashed: $isDashed, isHighlight: $isHighlight, text: $text, id: $id)';\n-  }\n-\n-  @override\n-  bool operator ==(Object other) {\n-    if (identical(this, other)) return true;\n-    return other is AppAnnotation &&\n-        other.id == id &&\n-        other.cfiContainingRange == cfiContainingRange &&\n-        other.color == color &&\n-        other.isDashed == isDashed &&\n-        other.isHighlight == isHighlight &&\n-        other.text == text;\n-  }\n-\n-  @override\n-  int get hashCode {\n-    return id.hashCode;\n-  }\n-}\n-\n-void main() {\n-  runApp(const MyApp());\n-}\n-\n-class MyApp extends StatelessWidget {\n-  const MyApp({super.key});\n-\n-  // This widget is the root of your application.\n-  @override\n-  Widget build(BuildContext context) {\n-    return MaterialApp(\n-      title: 'Flutter Demo',\n-      theme: ThemeData(\n-        // This is the theme of your application.\n-        //\n-        // TRY THIS: Try running your application with \"flutter run\". You'll see\n-        // the application has a purple toolbar. Then, without quitting the app,\n-        // try changing the seedColor in the colorScheme below to Colors.green\n-        // and then invoke \"hot reload\" (save your changes or press the \"hot\n-        // reload\" button in a Flutter-supported IDE, or press \"r\" if you used\n-        // the command line to start the app).\n-        //\n-        // Notice that the counter didn't reset back to zero; the application\n-        // state is not lost during the reload. To reset the state, use hot\n-        // restart instead.\n-        //\n-        // This works for code too, not just values: Most code changes can be\n-        // tested with just a hot reload.\n-        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),\n-        useMaterial3: true,\n-      ),\n-      home: const MyHomePage(title: 'Epub Viewer Demo'),\n-    );\n-  }\n-}\n-\n-class MyHomePage extends StatefulWidget {\n-  const MyHomePage({super.key, required this.title});\n-\n-  final String title;\n-\n-  @override\n-  State<MyHomePage> createState() => _MyHomePageState();\n-}\n-\n-class _MyHomePageState extends State<MyHomePage> {\n-  final epubController = EpubController();\n-\n-  var textSelectionCfi = '';\n-\n-  bool isLoading = true;\n-\n-  double progress = 0.0;\n-  int fontSize = 16;\n-\n-  @override\n-  Widget build(BuildContext context) {\n-    return Scaffold(\n-      drawer: ChapterDrawer(controller: epubController),\n-      appBar: AppBar(\n-        backgroundColor: Theme.of(context).colorScheme.inversePrimary,\n-        title: Text(widget.title),\n-        actions: [\n-          TextButton(\n-            onPressed: () {\n-              setState(() {\n-                fontSize = fontSize == 16 ? 35 : 16;\n-              });\n-              epubController.setFontSize(fontSize: fontSize.toDouble());\n-            },\n-            child: const Text('改字体'),\n-          ),\n-        ],\n-      ),\n-      body: SafeArea(\n-        child: Column(\n-          children: [\n-            LinearProgressIndicator(\n-              value: progress,\n-              backgroundColor: Colors.transparent,\n-            ),\n-            Expanded(\n-              child: Stack(\n-                children: [\n-                  EpubViewer(\n-                    epubSource: EpubSource.fromAsset(\n-                      'assets/epubs/test.epub',\n-                    ),\n-                    epubController: epubController,\n-                    displaySettings: EpubDisplaySettings(\n-                      fontSize: fontSize,\n-                      flow: EpubFlow.scrolled,\n-                      useSnapAnimationAndroid: false,\n-                      snap: true,\n-                      theme: EpubTheme.light(),\n-                      allowScriptedContent: true,\n-                    ),\n-                    selectionContextMenu: ContextMenu(\n-                      menuItems: [\n-                        ContextMenuItem(\n-                          title: \"Highlight\",\n-                          id: 1,\n-                          action: () async {\n-                            epubController.addHighlight(cfi: textSelectionCfi);\n-                          },\n-                        ),\n-                        ContextMenuItem(\n-                          title: \"Underline (red Dashed)\",\n-                          id: 4,\n-                          action: () async {\n-                            epubController.addUnderline(\n-                              cfi: textSelectionCfi,\n-                              color: Colors.red,\n-                              isDashed: true,\n-                            );\n-                          },\n-                        ),\n-                      ],\n-                      settings: ContextMenuSettings(\n-                        hideDefaultSystemContextMenuItems: true,\n-                      ),\n-                    ),\n-                    onChaptersLoaded: (chapters) {\n-                      setState(() {\n-                        isLoading = false;\n-                      });\n-                    },\n-                    onEpubLoaded: () async {\n-                      print('Epub loaded');\n-                    },\n-                    onRelocated: (value) {\n-                      print(\"Reloacted to $value\");\n-                      setState(() {\n-                        progress = value.progress;\n-                      });\n-                    },\n-                    onAnnotationClicked: (cfi) {\n-                      print(\"Annotation clicked $cfi\");\n-                    },\n-                    onTextSelected: (epubTextSelection) {\n-                      textSelectionCfi = epubTextSelection.selectionCfi;\n-                      print(textSelectionCfi);\n-                    },\n-                    onLocationLoaded: () {\n-                      /// progress will be available after this callback\n-                      print('on location loaded');\n-                    },\n-                    onSelection:\n-                        (selectedText, cfiRange, selectionRect, viewRect) {\n-                      print(\"On selection changes\");\n-                    },\n-                    onDeselection: () {\n-                      print(\"on delection\");\n-                    },\n-                    onSelectionChanging: () {\n-                      print(\"on slection chnages\");\n-                    },\n-                  ),\n-                  Visibility(\n-                    visible: isLoading,\n-                    child: const Center(child: CircularProgressIndicator()),\n-                  ),\n-                ],\n-              ),\n-            ),\n-          ],\n-        ),\n-      ),\n-    );\n-  }\n-}\n"
                },
                {
                    "date": 1762660467841,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,10 +34,10 @@\n \n   Map<String, dynamic> toJson() {\n     return {\n       'cfiContainingRange': cfiContainingRange,\n-      'color': color,\n-      'isDashed': isDashed,\n+      'myNote': myNote,\n+      'othersNote': othersNote,\n       'isHighlight': isHighlight,\n       'text': text,\n       'id': id,\n     };\n"
                },
                {
                    "date": 1762660473651,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,10 +53,10 @@\n     if (identical(this, other)) return true;\n     return other is AppAnnotation &&\n         other.id == id &&\n         other.cfiContainingRange == cfiContainingRange &&\n-        other.color == color &&\n-        other.isDashed == isDashed &&\n+        other.myNote == myNote &&\n+        other.othersNote == othersNote &&\n         other.isHighlight == isHighlight &&\n         other.text == text;\n   }\n \n"
                },
                {
                    "date": 1762660482994,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,15 +50,9 @@\n \n   @override\n   bool operator ==(Object other) {\n     if (identical(this, other)) return true;\n-    return other is AppAnnotation &&\n-        other.id == id &&\n-        other.cfiContainingRange == cfiContainingRange &&\n-        other.myNote == myNote &&\n-        other.othersNote == othersNote &&\n-        other.isHighlight == isHighlight &&\n-        other.text == text;\n+    return other is AppAnnotation && other.id == id;\n   }\n \n   @override\n   int get hashCode {\n"
                },
                {
                    "date": 1762660637978,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -166,9 +166,9 @@\n                             epubController.addHighlight(cfi: textSelectionCfi);\n                           },\n                         ),\n                         ContextMenuItem(\n-                          title: \"Underline\",\n+                          title: \"做笔记\",\n                           id: 4,\n                           action: () async {\n                             epubController.addUnderline(\n                               cfi: textSelectionCfi,\n"
                },
                {
                    "date": 1762661473790,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,94 +1,24 @@\n import 'package:flutter/material.dart';\n import 'package:flutter_epub_viewer/flutter_epub_viewer.dart';\n+import 'package:uuid/uuid.dart';\n \n+import 'annotation_manager.dart';\n+import 'app_annotation.dart';\n import 'chapter_drawer.dart';\n \n-class AppAnnotation {\n-  final String cfiContainingRange;\n-  final String? myNote;\n-  final String? othersNote;\n-\n-  final bool isHighlight;\n-  final String text;\n-  final String id;\n-\n-  AppAnnotation({\n-    required this.cfiContainingRange,\n-    required this.myNote,\n-    required this.othersNote,\n-    required this.isHighlight,\n-    required this.text,\n-    required this.id,\n-  });\n-\n-  factory AppAnnotation.fromJson(Map<String, dynamic> json) {\n-    return AppAnnotation(\n-      cfiContainingRange: json['cfiContainingRange'],\n-      myNote: json['myNote'],\n-      othersNote: json['othersNote'],\n-      isHighlight: json['isHighlight'],\n-      text: json['text'],\n-      id: json['id'],\n-    );\n-  }\n-\n-  Map<String, dynamic> toJson() {\n-    return {\n-      'cfiContainingRange': cfiContainingRange,\n-      'myNote': myNote,\n-      'othersNote': othersNote,\n-      'isHighlight': isHighlight,\n-      'text': text,\n-      'id': id,\n-    };\n-  }\n-\n-  @override\n-  String toString() {\n-    return 'AppAnnotation(cfiContainingRange: $cfiContainingRange, color: $color, isDashed: $isDashed, isHighlight: $isHighlight, text: $text, id: $id)';\n-  }\n-\n-  @override\n-  bool operator ==(Object other) {\n-    if (identical(this, other)) return true;\n-    return other is AppAnnotation && other.id == id;\n-  }\n-\n-  @override\n-  int get hashCode {\n-    return id.hashCode;\n-  }\n-}\n-\n void main() {\n   runApp(const MyApp());\n }\n \n class MyApp extends StatelessWidget {\n   const MyApp({super.key});\n \n-  // This widget is the root of your application.\n   @override\n   Widget build(BuildContext context) {\n     return MaterialApp(\n       title: 'Flutter Demo',\n       theme: ThemeData(\n-        // This is the theme of your application.\n-        //\n-        // TRY THIS: Try running your application with \"flutter run\". You'll see\n-        // the application has a purple toolbar. Then, without quitting the app,\n-        // try changing the seedColor in the colorScheme below to Colors.green\n-        // and then invoke \"hot reload\" (save your changes or press the \"hot\n-        // reload\" button in a Flutter-supported IDE, or press \"r\" if you used\n-        // the command line to start the app).\n-        //\n-        // Notice that the counter didn't reset back to zero; the application\n-        // state is not lost during the reload. To reset the state, use hot\n-        // restart instead.\n-        //\n-        // This works for code too, not just values: Most code changes can be\n-        // tested with just a hot reload.\n         colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),\n         useMaterial3: true,\n       ),\n       home: const MyHomePage(title: 'Epub Viewer Demo'),\n@@ -106,17 +36,241 @@\n }\n \n class _MyHomePageState extends State<MyHomePage> {\n   final epubController = EpubController();\n+  final annotationManager = AnnotationManager();\n+  final uuid = const Uuid();\n \n   var textSelectionCfi = '';\n+  var selectedText = '';\n \n   bool isLoading = true;\n-\n   double progress = 0.0;\n   int fontSize = 16;\n \n   @override\n+  void initState() {\n+    super.initState();\n+    _initAnnotations();\n+  }\n+\n+  Future<void> _initAnnotations() async {\n+    await annotationManager.init();\n+    // Restore annotations when epub is loaded\n+    annotationManager.addListener(_onAnnotationsChanged);\n+  }\n+\n+  void _onAnnotationsChanged() {\n+    setState(() {});\n+  }\n+\n+  @override\n+  void dispose() {\n+    annotationManager.removeListener(_onAnnotationsChanged);\n+    super.dispose();\n+  }\n+\n+  // Show dialog to input note\n+  Future<String?> _showNoteDialog({String? initialNote}) async {\n+    final controller = TextEditingController(text: initialNote);\n+    return showDialog<String>(\n+      context: context,\n+      builder: (context) => AlertDialog(\n+        title: const Text('做笔记'),\n+        content: TextField(\n+          controller: controller,\n+          decoration: const InputDecoration(\n+            hintText: '输入笔记内容...',\n+            border: OutlineInputBorder(),\n+          ),\n+          maxLines: 5,\n+          autofocus: true,\n+        ),\n+        actions: [\n+          TextButton(\n+            onPressed: () => Navigator.pop(context),\n+            child: const Text('取消'),\n+          ),\n+          TextButton(\n+            onPressed: () => Navigator.pop(context, controller.text),\n+            child: const Text('保存'),\n+          ),\n+        ],\n+      ),\n+    );\n+  }\n+\n+  // Show list of notes for a CFI\n+  Future<void> _showNotesListDialog(String cfi) async {\n+    final notes = annotationManager.getNotesByCfi(cfi);\n+    if (notes.isEmpty) return;\n+\n+    await showDialog(\n+      context: context,\n+      builder: (context) => AlertDialog(\n+        title: const Text('笔记列表'),\n+        content: SizedBox(\n+          width: double.maxFinite,\n+          child: ListView.builder(\n+            shrinkWrap: true,\n+            itemCount: notes.length,\n+            itemBuilder: (context, index) {\n+              final note = notes[index];\n+              return Card(\n+                child: ListTile(\n+                  title: Text(note.myNote ?? ''),\n+                  subtitle: Text(\n+                    '创建时间: ${note.createdAt.toString().substring(0, 19)}',\n+                    style: Theme.of(context).textTheme.bodySmall,\n+                  ),\n+                  trailing: IconButton(\n+                    icon: const Icon(Icons.delete),\n+                    onPressed: () async {\n+                      // Remove the annotation\n+                      await annotationManager.removeAnnotation(note.id);\n+\n+                      // Check if there are remaining notes for this CFI\n+                      final remaining = annotationManager.getNotesByCfi(cfi);\n+\n+                      // Remove the underline\n+                      await epubController.removeUnderline(cfi: cfi);\n+\n+                      // If there are still notes, re-add the underline\n+                      if (remaining.isNotEmpty) {\n+                        epubController.addUnderline(\n+                          cfi: cfi,\n+                          color: Colors.red,\n+                          isDashed: true,\n+                        );\n+                      }\n+\n+                      // Close dialog if no more notes\n+                      if (remaining.isEmpty) {\n+                        Navigator.pop(context);\n+                      } else {\n+                        // Refresh the dialog\n+                        Navigator.pop(context);\n+                        _showNotesListDialog(cfi);\n+                      }\n+                    },\n+                  ),\n+                ),\n+              );\n+            },\n+          ),\n+        ),\n+        actions: [\n+          TextButton(\n+            onPressed: () => Navigator.pop(context),\n+            child: const Text('关闭'),\n+          ),\n+        ],\n+      ),\n+    );\n+  }\n+\n+  // Add note annotation\n+  Future<void> _addNoteAnnotation() async {\n+    if (textSelectionCfi.isEmpty) return;\n+\n+    final noteText = await _showNoteDialog();\n+    if (noteText == null || noteText.isEmpty) return;\n+\n+    // Check if this CFI already has notes\n+    final hasExistingNotes = annotationManager.hasNotes(textSelectionCfi);\n+\n+    // Create annotation\n+    final annotation = AppAnnotation(\n+      id: uuid.v4(),\n+      cfi: textSelectionCfi,\n+      type: AnnotationType.note,\n+      color: Colors.red,\n+      myNote: noteText,\n+    );\n+\n+    // Save to manager\n+    await annotationManager.addAnnotation(annotation);\n+\n+    // Add visual underline (only if not already present)\n+    if (!hasExistingNotes) {\n+      epubController.addUnderline(\n+        cfi: textSelectionCfi,\n+        color: Colors.red,\n+        isDashed: true,\n+      );\n+    }\n+\n+    setState(() {});\n+  }\n+\n+  // Add highlight annotation\n+  Future<void> _addHighlightAnnotation() async {\n+    if (textSelectionCfi.isEmpty) return;\n+\n+    final annotation = AppAnnotation(\n+      id: uuid.v4(),\n+      cfi: textSelectionCfi,\n+      type: AnnotationType.highlight,\n+      color: Colors.yellow,\n+    );\n+\n+    await annotationManager.addAnnotation(annotation);\n+    epubController.addHighlight(cfi: textSelectionCfi);\n+\n+    setState(() {});\n+  }\n+\n+  // Remove highlight annotation\n+  Future<void> _removeHighlightAnnotation() async {\n+    if (textSelectionCfi.isEmpty) return;\n+\n+    await annotationManager.removeAnnotationsByCfi(\n+      textSelectionCfi,\n+      type: AnnotationType.highlight,\n+    );\n+    epubController.removeHighlight(cfi: textSelectionCfi);\n+\n+    setState(() {});\n+  }\n+\n+  // Build context menu items dynamically\n+  List<ContextMenuItem> _buildContextMenuItems() {\n+    final items = <ContextMenuItem>[];\n+    final hasHighlight = annotationManager.hasHighlight(textSelectionCfi);\n+\n+    if (hasHighlight) {\n+      // If already highlighted, show \"取消高亮\"\n+      items.add(\n+        ContextMenuItem(\n+          title: \"取消高亮\",\n+          id: 1,\n+          action: _removeHighlightAnnotation,\n+        ),\n+      );\n+    } else {\n+      // Otherwise show \"高亮\"\n+      items.add(\n+        ContextMenuItem(\n+          title: \"高亮\",\n+          id: 2,\n+          action: _addHighlightAnnotation,\n+        ),\n+      );\n+    }\n+\n+    // Always show \"做笔记\"\n+    items.add(\n+      ContextMenuItem(\n+        title: \"做笔记\",\n+        id: 3,\n+        action: _addNoteAnnotation,\n+      ),\n+    );\n+\n+    return items;\n+  }\n+\n+  @override\n   Widget build(BuildContext context) {\n     return Scaffold(\n       drawer: ChapterDrawer(controller: epubController),\n       appBar: AppBar(\n@@ -131,8 +285,58 @@\n               epubController.setFontSize(fontSize: fontSize.toDouble());\n             },\n             child: const Text('改字体'),\n           ),\n+          // Debug: Clear all annotations\n+          IconButton(\n+            icon: const Icon(Icons.clear_all),\n+            tooltip: '清除所有标注',\n+            onPressed: () async {\n+              // Show confirmation dialog\n+              final confirmed = await showDialog<bool>(\n+                context: context,\n+                builder: (context) => AlertDialog(\n+                  title: const Text('确认'),\n+                  content: const Text('确定要清除所有标注吗？此操作不可恢复。'),\n+                  actions: [\n+                    TextButton(\n+                      onPressed: () => Navigator.pop(context, false),\n+                      child: const Text('取消'),\n+                    ),\n+                    TextButton(\n+                      onPressed: () => Navigator.pop(context, true),\n+                      child: const Text('确定'),\n+                    ),\n+                  ],\n+                ),\n+              );\n+\n+              if (confirmed == true) {\n+                // Get all CFIs before clearing\n+                final highlightCfis = annotationManager.annotations\n+                    .where((a) => a.type == AnnotationType.highlight)\n+                    .map((a) => a.cfi)\n+                    .toSet();\n+                final noteCfis = annotationManager.annotations\n+                    .where((a) => a.type == AnnotationType.note)\n+                    .map((a) => a.cfi)\n+                    .toSet();\n+\n+                // Clear from storage\n+                await annotationManager.clearAll();\n+\n+                // Remove visual annotations\n+                for (final cfi in highlightCfis) {\n+                  epubController.removeHighlight(cfi: cfi);\n+                }\n+                for (final cfi in noteCfis) {\n+                  epubController.removeUnderline(cfi: cfi);\n+                }\n+\n+                setState(() {});\n+              }\n+            },\n+          ),\n         ],\n       ),\n       body: SafeArea(\n         child: Column(\n@@ -157,28 +361,9 @@\n                       theme: EpubTheme.light(),\n                       allowScriptedContent: true,\n                     ),\n                     selectionContextMenu: ContextMenu(\n-                      menuItems: [\n-                        ContextMenuItem(\n-                          title: \"Highlight\",\n-                          id: 1,\n-                          action: () async {\n-                            epubController.addHighlight(cfi: textSelectionCfi);\n-                          },\n-                        ),\n-                        ContextMenuItem(\n-                          title: \"做笔记\",\n-                          id: 4,\n-                          action: () async {\n-                            epubController.addUnderline(\n-                              cfi: textSelectionCfi,\n-                              color: Colors.red,\n-                              isDashed: true,\n-                            );\n-                          },\n-                        ),\n-                      ],\n+                      menuItems: _buildContextMenuItems(),\n                       settings: ContextMenuSettings(\n                         hideDefaultSystemContextMenuItems: true,\n                       ),\n                     ),\n@@ -188,35 +373,64 @@\n                       });\n                     },\n                     onEpubLoaded: () async {\n                       print('Epub loaded');\n+                      // Restore all annotations\n+                      final noteCfis = <String>{};\n+\n+                      for (final annotation in annotationManager.annotations) {\n+                        if (annotation.type == AnnotationType.highlight) {\n+                          epubController.addHighlight(\n+                            cfi: annotation.cfi,\n+                            color: annotation.color,\n+                          );\n+                        } else if (annotation.type == AnnotationType.note) {\n+                          // Only add underline once per CFI\n+                          if (!noteCfis.contains(annotation.cfi)) {\n+                            noteCfis.add(annotation.cfi);\n+                            epubController.addUnderline(\n+                              cfi: annotation.cfi,\n+                              color: Colors.red,\n+                              isDashed: true,\n+                            );\n+                          }\n+                        }\n+                      }\n                     },\n                     onRelocated: (value) {\n                       print(\"Reloacted to $value\");\n                       setState(() {\n                         progress = value.progress;\n                       });\n                     },\n                     onAnnotationClicked: (cfi) {\n-                      print(\"Annotation clicked $cfi\");\n+                      print(\"Annotation clicked: $cfi\");\n+                      // Check if this CFI has notes\n+                      if (annotationManager.hasNotes(cfi)) {\n+                        _showNotesListDialog(cfi);\n+                      } else {\n+                        print(\"No notes found for this annotation\");\n+                      }\n                     },\n                     onTextSelected: (epubTextSelection) {\n-                      textSelectionCfi = epubTextSelection.selectionCfi;\n-                      print(textSelectionCfi);\n+                      setState(() {\n+                        textSelectionCfi = epubTextSelection.selectionCfi;\n+                        selectedText = epubTextSelection.selectedText;\n+                      });\n+                      print('Selected: $textSelectionCfi');\n                     },\n                     onLocationLoaded: () {\n-                      /// progress will be available after this callback\n                       print('on location loaded');\n                     },\n                     onSelection:\n                         (selectedText, cfiRange, selectionRect, viewRect) {\n                       print(\"On selection changes\");\n                     },\n                     onDeselection: () {\n-                      print(\"on delection\");\n+                      print(\"on deselection\");\n                     },\n                     onSelectionChanging: () {\n-                      print(\"on slection chnages\");\n+                      print(\"on selection changing\");\n                     },\n                   ),\n                   Visibility(\n                     visible: isLoading,\n"
                },
                {
                    "date": 1762661869799,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,9 +182,8 @@\n     final annotation = AppAnnotation(\n       id: uuid.v4(),\n       cfi: textSelectionCfi,\n       type: AnnotationType.note,\n-      color: Colors.red,\n       myNote: noteText,\n     );\n \n     // Save to manager\n@@ -209,9 +208,8 @@\n     final annotation = AppAnnotation(\n       id: uuid.v4(),\n       cfi: textSelectionCfi,\n       type: AnnotationType.highlight,\n-      color: Colors.yellow,\n     );\n \n     await annotationManager.addAnnotation(annotation);\n     epubController.addHighlight(cfi: textSelectionCfi);\n@@ -380,9 +378,9 @@\n                       for (final annotation in annotationManager.annotations) {\n                         if (annotation.type == AnnotationType.highlight) {\n                           epubController.addHighlight(\n                             cfi: annotation.cfi,\n-                            color: annotation.color,\n+                            color: Colors.yellow,\n                           );\n                         } else if (annotation.type == AnnotationType.note) {\n                           // Only add underline once per CFI\n                           if (!noteCfis.contains(annotation.cfi)) {\n"
                },
                {
                    "date": 1762662278761,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,9 +5,10 @@\n import 'annotation_manager.dart';\n import 'app_annotation.dart';\n import 'chapter_drawer.dart';\n \n-void main() {\n+void main() async{\n+  WidgetsFlutterBinding.ensureInitialized();\n   runApp(const MyApp());\n }\n \n class MyApp extends StatelessWidget {\n"
                }
            ],
            "date": 1762656180806,
            "name": "Commit-0",
            "content": "import 'package:flutter/material.dart';\nimport 'package:flutter_epub_viewer/flutter_epub_viewer.dart';\n\nvoid main() {\n  runApp(const MyApp());\n}\n\nclass MyApp extends StatelessWidget {\n  const MyApp({super.key});\n\n  // This widget is the root of your application.\n  @override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: 'Flutter Demo',\n      theme: ThemeData(\n        // This is the theme of your application.\n        //\n        // TRY THIS: Try running your application with \"flutter run\". You'll see\n        // the application has a purple toolbar. Then, without quitting the app,\n        // try changing the seedColor in the colorScheme below to Colors.green\n        // and then invoke \"hot reload\" (save your changes or press the \"hot\n        // reload\" button in a Flutter-supported IDE, or press \"r\" if you used\n        // the command line to start the app).\n        //\n        // Notice that the counter didn't reset back to zero; the application\n        // state is not lost during the reload. To reset the state, use hot\n        // restart instead.\n        //\n        // This works for code too, not just values: Most code changes can be\n        // tested with just a hot reload.\n        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),\n        useMaterial3: true,\n      ),\n      home: const MyHomePage(title: 'Epub Viewer Demo'),\n    );\n  }\n}\n\nclass MyHomePage extends StatefulWidget {\n  const MyHomePage({super.key, required this.title});\n\n  final String title;\n\n  @override\n  State<MyHomePage> createState() => _MyHomePageState();\n}\n\nclass _MyHomePageState extends State<MyHomePage> {\n  final epubController = EpubController();\n\n  var textSelectionCfi = '';\n\n  bool isLoading = true;\n\n  double progress = 0.0;\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      drawer: ChapterDrawer(controller: epubController),\n      appBar: AppBar(\n        backgroundColor: Theme.of(context).colorScheme.inversePrimary,\n        title: Text(widget.title),\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.search),\n            onPressed: () {\n              epubController.setFontSize(fontSize: 35);\n            },\n          ),\n        ],\n      ),\n      body: SafeArea(\n        child: Column(\n          children: [\n            LinearProgressIndicator(\n              value: progress,\n              backgroundColor: Colors.transparent,\n            ),\n            Expanded(\n              child: Stack(\n                children: [\n                  EpubViewer(\n                    initialCfi: 'epubcfi(/6/20!/4/2[introduction]/2[c1_h]/1:0)',\n                    epubSource: EpubSource.fromUrl(\n                      'https://github.com/IDPF/epub3-samples/releases/download/20230704/accessible_epub_3.epub',\n                    ),\n                    epubController: epubController,\n                    displaySettings: EpubDisplaySettings(\n                      flow: EpubFlow.paginated,\n                      useSnapAnimationAndroid: false,\n                      snap: true,\n                      theme: EpubTheme.light(),\n                      allowScriptedContent: true,\n                    ),\n                    selectionContextMenu: ContextMenu(\n                      menuItems: [\n                        ContextMenuItem(\n                          title: \"Highlight\",\n                          id: 1,\n                          action: () async {\n                            epubController.addHighlight(cfi: textSelectionCfi);\n                          },\n                        ),\n                      ],\n                      settings: ContextMenuSettings(\n                        hideDefaultSystemContextMenuItems: true,\n                      ),\n                    ),\n                    onChaptersLoaded: (chapters) {\n                      setState(() {\n                        isLoading = false;\n                      });\n                    },\n                    onEpubLoaded: () async {\n                      print('Epub loaded');\n                    },\n                    onRelocated: (value) {\n                      print(\"Reloacted to $value\");\n                      setState(() {\n                        progress = value.progress;\n                      });\n                    },\n                    onAnnotationClicked: (cfi) {\n                      print(\"Annotation clicked $cfi\");\n                    },\n                    onTextSelected: (epubTextSelection) {\n                      textSelectionCfi = epubTextSelection.selectionCfi;\n                      print(textSelectionCfi);\n                    },\n                    onLocationLoaded: () {\n                      /// progress will be available after this callback\n                      print('on location loaded');\n                    },\n                    onSelection:\n                        (selectedText, cfiRange, selectionRect, viewRect) {\n                          print(\"On selection changes\");\n                        },\n                    onDeselection: () {\n                      print(\"on delection\");\n                    },\n                    onSelectionChanging: () {\n                      print(\"on slection chnages\");\n                    },\n                  ),\n                  Visibility(\n                    visible: isLoading,\n                    child: const Center(child: CircularProgressIndicator()),\n                  ),\n                ],\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n"
        }
    ]
}